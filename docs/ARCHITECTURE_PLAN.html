<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>PNADCperiods - Architecture Documentation • PNADCperiods</title><script src="deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><link href="deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet"><script src="deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet"><link href="deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet"><script src="deps/headroom-0.11.0/headroom.min.js"></script><script src="deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="deps/search-1.0.0/fuse.min.js"></script><script src="deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="pkgdown.js"></script><meta property="og:title" content="PNADCperiods - Architecture Documentation"></head><body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-primary" data-bs-theme="dark" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="index.html">PNADCperiods</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.1.0</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto"><li class="nav-item"><a class="nav-link" href="articles/getting-started.html">Get Started</a></li>
<li class="nav-item"><a class="nav-link" href="reference/index.html">Reference</a></li>
<li class="nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles"><li><a class="dropdown-item" href="articles/download-and-prepare.html">Download and Prepare Data</a></li>
    <li><a class="dropdown-item" href="articles/sidra-mensalization.html">SIDRA Mensalization Guide</a></li>
    <li><a class="dropdown-item" href="articles/applied-examples.html">Applied Examples</a></li>
    <li><a class="dropdown-item" href="articles/annual-poverty-analysis.html">Annual Poverty Analysis</a></li>
    <li><a class="dropdown-item" href="articles/complex-survey-design.html">Complex Survey Design</a></li>
    <li><a class="dropdown-item" href="articles/how-it-works.html">How PNADCperiods Works</a></li>
    <li><hr class="dropdown-divider"></li>
    <li><a class="dropdown-item" href="articles/determination-rates-benchmark.html">Benchmark Report</a></li>
  </ul></li>
      </ul><ul class="navbar-nav"><li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="search.json"></form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/antrologos/PNADCperiods/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul></div>


  </div>
</nav><div class="container template-title-body">
<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>PNADCperiods - Architecture Documentation</h1>
      <small class="dont-index">Source: <a href="https://github.com/antrologos/PNADCperiods/blob/HEAD/ARCHITECTURE_PLAN.md" class="external-link"><code>ARCHITECTURE_PLAN.md</code></a></small>
    </div>

<div id="pnadcperiods---architecture-documentation" class="section level1">

<p>This document describes the implemented architecture of the PNADCperiods package.</p>
<div class="section level2">
<h2 id="package-overview">Package Overview<a class="anchor" aria-label="anchor" href="#package-overview"></a></h2>
<p><strong>Package name:</strong> <code>PNADCperiods</code> <strong>Purpose:</strong> Identify reference periods (months, fortnights, weeks) in Brazil’s PNADC survey data and calibrate weights for sub-quarterly analysis.</p>
</div>
<div class="section level2">
<h2 id="api-design">API Design<a class="anchor" aria-label="anchor" href="#api-design"></a></h2>
<div class="section level3">
<h3 id="core-functions">Core Functions<a class="anchor" aria-label="anchor" href="#core-functions"></a></h3>
<table class="table"><colgroup><col width="52%"><col width="47%"></colgroup><thead><tr><th>Function</th>
<th>Purpose</th>
</tr></thead><tbody><tr><td><code><a href="reference/pnadc_identify_periods.html">pnadc_identify_periods()</a></code></td>
<td>Build crosswalk with nested month/fortnight/week identification</td>
</tr><tr><td><code><a href="reference/pnadc_apply_periods.html">pnadc_apply_periods()</a></code></td>
<td>Apply crosswalk to data + adaptive weight calibration</td>
</tr></tbody></table></div>
<div class="section level3">
<h3 id="experimental-extension">Experimental Extension<a class="anchor" aria-label="anchor" href="#experimental-extension"></a></h3>
<table class="table"><colgroup><col width="52%"><col width="47%"></colgroup><thead><tr><th>Function</th>
<th>Purpose</th>
</tr></thead><tbody><tr><td><code><a href="reference/pnadc_experimental_periods.html">pnadc_experimental_periods()</a></code></td>
<td>Probabilistic + UPA aggregation strategies for higher determination rates</td>
</tr></tbody></table></div>
<div class="section level3">
<h3 id="supporting-functions">Supporting Functions<a class="anchor" aria-label="anchor" href="#supporting-functions"></a></h3>
<table class="table"><colgroup><col width="52%"><col width="47%"></colgroup><thead><tr><th>Function</th>
<th>Purpose</th>
</tr></thead><tbody><tr><td><code><a href="reference/fetch_monthly_population.html">fetch_monthly_population()</a></code></td>
<td>Fetch population from SIDRA API (table 6022)</td>
</tr><tr><td><code><a href="reference/validate_pnadc.html">validate_pnadc()</a></code></td>
<td>Input validation with detailed error reporting</td>
</tr><tr><td><code><a href="reference/clear_sidra_cache.html">clear_sidra_cache()</a></code></td>
<td>Clear all cached SIDRA data</td>
</tr></tbody></table></div>
<div class="section level3">
<h3 id="sidra-series-mensalization">SIDRA Series Mensalization<a class="anchor" aria-label="anchor" href="#sidra-series-mensalization"></a></h3>
<table class="table"><colgroup><col width="52%"><col width="47%"></colgroup><thead><tr><th>Function</th>
<th>Purpose</th>
</tr></thead><tbody><tr><td><code><a href="reference/get_sidra_series_metadata.html">get_sidra_series_metadata()</a></code></td>
<td>List 86+ available PNADC rolling quarter series</td>
</tr><tr><td><code><a href="reference/fetch_sidra_rolling_quarters.html">fetch_sidra_rolling_quarters()</a></code></td>
<td>Download rolling quarterly data from SIDRA API</td>
</tr><tr><td><code><a href="reference/mensalize_sidra_series.html">mensalize_sidra_series()</a></code></td>
<td>Convert rolling quarters to exact monthly estimates</td>
</tr><tr><td><code><a href="reference/compute_starting_points_from_microdata.html">compute_starting_points_from_microdata()</a></code></td>
<td>Compute y0 starting points from PNADC microdata</td>
</tr><tr><td><code><a href="reference/compute_series_starting_points.html">compute_series_starting_points()</a></code></td>
<td>Compute y0 from pre-aggregated z values</td>
</tr><tr><td><code><a href="reference/compute_z_aggregates.html">compute_z_aggregates()</a></code></td>
<td>Compute weighted aggregates by period</td>
</tr></tbody></table></div>
</div>
<div class="section level2">
<h2 id="nested-identification-strategy">Nested Identification Strategy<a class="anchor" aria-label="anchor" href="#nested-identification-strategy"></a></h2>
<p>The package uses a <strong>nested identification hierarchy</strong>:</p>
<pre><code>Month → Fortnight → Week</code></pre>
<p><strong>Key principle:</strong> A finer period can only be determined if its parent period is determined.</p>
<table class="table"><thead><tr><th>Phase</th>
<th>Period</th>
<th>Requires</th>
<th>Aggregation Level</th>
</tr></thead><tbody><tr><td>1</td>
<td>Month</td>
<td>-</td>
<td>UPA-V1014 across ALL quarters</td>
</tr><tr><td>2</td>
<td>Fortnight</td>
<td>Month determined</td>
<td>Household within quarter</td>
</tr><tr><td>3</td>
<td>Week</td>
<td>Fortnight determined</td>
<td>Household within quarter</td>
</tr></tbody></table><p>This nesting ensures logical consistency: you cannot know which week without knowing which fortnight, and you cannot know which fortnight without knowing which month.</p>
</div>
<div class="section level2">
<h2 id="crosswalk-structure">Crosswalk Structure<a class="anchor" aria-label="anchor" href="#crosswalk-structure"></a></h2>
<p>The crosswalk is a <code>data.table</code> at household-quarter level:</p>
<table class="table"><colgroup><col width="29%"><col width="22%"><col width="48%"></colgroup><thead><tr><th>Column</th>
<th>Type</th>
<th>Description</th>
</tr></thead><tbody><tr><td><code>Ano</code></td>
<td>integer</td>
<td>Survey year</td>
</tr><tr><td><code>Trimestre</code></td>
<td>integer</td>
<td>Quarter (1-4)</td>
</tr><tr><td><code>UPA</code></td>
<td>integer</td>
<td>Primary sampling unit</td>
</tr><tr><td><code>V1008</code></td>
<td>integer</td>
<td>Household sequence</td>
</tr><tr><td><code>V1014</code></td>
<td>integer</td>
<td>Panel group (1-8)</td>
</tr><tr><td><code>ref_month_in_quarter</code></td>
<td>integer</td>
<td>Position in quarter (1, 2, 3) or NA</td>
</tr><tr><td><code>ref_month_in_year</code></td>
<td>integer</td>
<td>Position in year (1-12) or NA</td>
</tr><tr><td><code>ref_month_yyyymm</code></td>
<td>integer</td>
<td>YYYYMM format (e.g., 202301)</td>
</tr><tr><td><code>determined_month</code></td>
<td>logical</td>
<td>TRUE if month was determined</td>
</tr><tr><td><code>ref_fortnight_in_month</code></td>
<td>integer</td>
<td>Position in month (1 or 2) or NA</td>
</tr><tr><td><code>ref_fortnight_in_quarter</code></td>
<td>integer</td>
<td>Position in quarter (1-6) or NA</td>
</tr><tr><td><code>ref_fortnight_yyyyff</code></td>
<td>integer</td>
<td>YYYYFF format (1-24 per year)</td>
</tr><tr><td><code>determined_fortnight</code></td>
<td>logical</td>
<td>TRUE if fortnight was determined</td>
</tr><tr><td><code>ref_week_in_month</code></td>
<td>integer</td>
<td>Position in month (1-4) or NA</td>
</tr><tr><td><code>ref_week_in_quarter</code></td>
<td>integer</td>
<td>Position in quarter (1-12) or NA</td>
</tr><tr><td><code>ref_week_yyyyww</code></td>
<td>integer</td>
<td>IBGE YYYYWW format</td>
</tr><tr><td><code>determined_week</code></td>
<td>logical</td>
<td>TRUE if week was determined</td>
</tr></tbody></table><p><strong>Join keys:</strong> <code>Ano</code>, <code>Trimestre</code>, <code>UPA</code>, <code>V1008</code>, <code>V1014</code></p>
<p>When <code>store_date_bounds = TRUE</code>, additional columns include date bounds and debugging variables (see function documentation).</p>
</div>
<div class="section level2">
<h2 id="determination-rates">Determination Rates<a class="anchor" aria-label="anchor" href="#determination-rates"></a></h2>
<p><strong>Strict algorithm (full series 2012-2025):</strong></p>
<table class="table"><colgroup><col width="36%"><col width="27%"><col width="36%"></colgroup><thead><tr><th>Period</th>
<th>Rate</th>
<th>Reason</th>
</tr></thead><tbody><tr><td>Month</td>
<td>~97%</td>
<td>Aggregates at UPA-V1014 level across ALL quarters (panel design)</td>
</tr><tr><td>Fortnight</td>
<td>~9%</td>
<td>Nested under month; household-level within quarter only</td>
</tr><tr><td>Week</td>
<td>~3%</td>
<td>Nested under fortnight; household-level within quarter only</td>
</tr></tbody></table><p>With smaller datasets, rates may differ (e.g., 8 quarters 2019-2020: ~94% month).</p>
<p><strong>Experimental strategies (probabilistic + UPA aggregation) improve upon these rates.</strong></p>
<p><strong>Key insight:</strong> Only month identification benefits from stacking data across quarters. Fortnights and weeks are determined solely from birthday constraints within a single quarter, AND require their parent period to be determined first.</p>
</div>
<div class="section level2">
<h2 id="file-structure">File Structure<a class="anchor" aria-label="anchor" href="#file-structure"></a></h2>
<pre><code>R/
├── pnadc-identify-periods.R         # pnadc_identify_periods() - nested 4-phase algorithm
├── pnadc-apply-periods.R            # pnadc_apply_periods() - adaptive calibration + smoothing
├── pnadc-experimental-periods.R     # pnadc_experimental_periods() - probabilistic/UPA strategies
├── fetch-sidra-population.R         # fetch_monthly_population() - SIDRA population API
├── fetch-sidra-series.R             # fetch_sidra_rolling_quarters() + unified SIDRA cache
├── mensalize-sidra-series.R         # mensalize_sidra_series() - rolling quarters → monthly
├── sidra-series-metadata.R          # get_sidra_series_metadata() - 86+ series definitions
├── data-starting-points.R           # compute_*() functions + pnadc_series_starting_points dataset
├── utils-dates.R                    # Fast IBGE date utilities (lookup tables, week/fortnight functions)
├── utils-validation.R               # validate_pnadc() + internal helpers
└── PNADCperiods-package.R           # Package docs + globalVariables</code></pre>
</div>
<div class="section level2">
<h2 id="algorithm-details">Algorithm Details<a class="anchor" aria-label="anchor" href="#algorithm-details"></a></h2>
<div class="section level3">
<h3 id="phase-1-month-identification-high-rate">Phase 1: Month Identification (High Rate)<a class="anchor" aria-label="anchor" href="#phase-1-month-identification-high-rate"></a></h3>
<ol style="list-style-type: decimal"><li>Calculate valid interview Saturdays using IBGE “Parada Técnica” rules</li>
<li>Apply birthday constraints to narrow date range per person</li>
<li>Convert dates to month positions (1, 2, 3 in quarter)</li>
<li>
<strong>Aggregate at UPA-V1014 level ACROSS ALL QUARTERS</strong> (key optimization)</li>
<li>Dynamic exception detection for edge cases (relaxed Saturday rules)</li>
<li>Determine: if <code>min_position == max_position</code> → determined</li>
</ol></div>
<div class="section level3">
<h3 id="phase-2-fortnight-identification-nested-low-rate">Phase 2: Fortnight Identification (Nested, Low Rate)<a class="anchor" aria-label="anchor" href="#phase-2-fortnight-identification-nested-low-rate"></a></h3>
<p><strong>Precondition:</strong> Only processes observations with <code>determined_month = TRUE</code></p>
<ol style="list-style-type: decimal"><li>Constrain fortnight search to within the identified month:
<ul><li>Month 1 → fortnights 1-2</li>
<li>Month 2 → fortnights 3-4</li>
<li>Month 3 → fortnights 5-6</li>
</ul></li>
<li>Apply birthday constraints within constrained range</li>
<li><strong>Aggregate at household level <code>(Ano, Trimestre, UPA, V1008)</code> WITHIN QUARTER</strong></li>
<li>Dynamic exception detection</li>
<li>Determine: if <code>min_position == max_position</code> → determined</li>
</ol></div>
<div class="section level3">
<h3 id="phase-3-week-identification-nested-low-rate">Phase 3: Week Identification (Nested, Low Rate)<a class="anchor" aria-label="anchor" href="#phase-3-week-identification-nested-low-rate"></a></h3>
<p><strong>Precondition:</strong> Only processes observations with <code>determined_fortnight = TRUE</code></p>
<ol style="list-style-type: decimal"><li>Constrain week search to within the identified fortnight</li>
<li>Apply birthday constraints within constrained range</li>
<li><strong>Aggregate at household level <code>(Ano, Trimestre, UPA, V1008)</code> WITHIN QUARTER</strong></li>
<li>Dynamic exception detection</li>
<li>
<strong>Technical Stop Handling:</strong>
<ul><li>Rule 3.1: Quarter boundary stops → assign to week 12 (last week of quarter)</li>
<li>Rule 3.2: Within-quarter stops → use household consensus when available</li>
<li>Rule 3.3: Fallback → first valid week after technical stop</li>
</ul></li>
<li>Determine: if <code>min_position == max_position</code> → determined</li>
</ol></div>
<div class="section level3">
<h3 id="phase-4-build-crosswalk">Phase 4: Build Crosswalk<a class="anchor" aria-label="anchor" href="#phase-4-build-crosswalk"></a></h3>
<p>Combines results from all phases into the final crosswalk data.table with: - IBGE period boundaries (start/end dates as Sunday-Saturday) - Position codes (in_quarter) - YYYYMM/YYYYFF/YYYYWW integer codes - Determination flags</p>
</div>
</div>
<div class="section level2">
<h2 id="experimental-strategies">Experimental Strategies<a class="anchor" aria-label="anchor" href="#experimental-strategies"></a></h2>
<p>The <code><a href="reference/pnadc_experimental_periods.html">pnadc_experimental_periods()</a></code> function provides three strategies for improving determination rates beyond the strict algorithm:</p>
<table class="table"><colgroup><col width="43%"><col width="56%"></colgroup><thead><tr><th>Strategy</th>
<th>Description</th>
</tr></thead><tbody><tr><td><code>probabilistic</code></td>
<td>For 2-period ranges, assigns based on which period contains most of the date interval. Works at UPA-V1014 level for months, household level for fortnights/weeks.</td>
</tr><tr><td><code>upa_aggregation</code></td>
<td>Extends strictly identified periods to other observations in same UPA/UPA-V1014 when a consensus exists.</td>
</tr><tr><td><code>both</code></td>
<td>Sequentially applies probabilistic first, then UPA aggregation. Guarantees identification rate &gt;= max of individual strategies.</td>
</tr></tbody></table><p><strong>All strategies enforce proper nesting:</strong> experimental fortnights require identified months (strict or experimental), experimental weeks require identified fortnights (strict or experimental).</p>
<div class="section level3">
<h3 id="strategy-details">Strategy Details<a class="anchor" aria-label="anchor" href="#strategy-details"></a></h3>
<ul><li>
<strong>Probabilistic:</strong> Calculates confidence as the proportion of the date interval falling within the assigned period. Only assigns when confidence &gt;= threshold (default 0.9). Implements same dynamic exception detection as strict algorithm.</li>
<li>
<strong>UPA Aggregation:</strong> Uses UPA-V1014 level for months (panel design), UPA level for fortnights/weeks (all households in same UPA interviewed in same period within quarter). Requires proportion &gt;= threshold (default 0.5).</li>
<li>
<strong>Both:</strong> Strategies operate independently - probabilistic captures narrow ranges, UPA aggregation extends based on strict consensus. Result is union of both.</li>
</ul></div>
<div class="section level3">
<h3 id="output-columns">Output Columns<a class="anchor" aria-label="anchor" href="#output-columns"></a></h3>
<p>Output is directly compatible with <code><a href="reference/pnadc_apply_periods.html">pnadc_apply_periods()</a></code>:</p>
<table class="table"><colgroup><col width="38%"><col width="61%"></colgroup><thead><tr><th>Column</th>
<th>Description</th>
</tr></thead><tbody><tr><td>
<code>ref_month_in_quarter</code>, <code>ref_fortnight_in_month</code>, <code>ref_week_in_month</code>
</td>
<td>Combined strict + experimental positions</td>
</tr><tr><td>
<code>ref_month_yyyymm</code>, <code>ref_fortnight_yyyyff</code>, <code>ref_week_yyyyww</code>
</td>
<td>YYYYMM/FF/WW codes</td>
</tr><tr><td>
<code>determined_month</code>, <code>determined_fortnight</code>, <code>determined_week</code>
</td>
<td>TRUE if assigned (strict or experimental)</td>
</tr><tr><td><code>determined_probable_month/fortnight/week</code></td>
<td>TRUE if assigned by probabilistic strategy</td>
</tr><tr><td><code>probabilistic_assignment</code></td>
<td>TRUE if any period assigned experimentally</td>
</tr><tr><td>
<code>week_1_start</code> … <code>week_4_end</code>
</td>
<td>IBGE week boundaries for assigned month</td>
</tr></tbody></table></div>
</div>
<div class="section level2">
<h2 id="calibration-pipeline">Calibration Pipeline<a class="anchor" aria-label="anchor" href="#calibration-pipeline"></a></h2>
<p>When <code>pnadc_apply_periods(..., calibrate = TRUE)</code>:</p>
<ol style="list-style-type: decimal"><li>Join data with crosswalk</li>
<li>Fetch population targets from SIDRA (or use provided targets)</li>
<li>Create hierarchical calibration cells (auto-selected based on period)</li>
<li>Iterative reweighting within anchor period (quarter or year)</li>
<li>Calibrate to external population totals (FULL Brazilian population)</li>
<li>Apply smoothing (period-specific)</li>
</ol><div class="section level3">
<h3 id="period-specific-calibration-settings">Period-Specific Calibration Settings<a class="anchor" aria-label="anchor" href="#period-specific-calibration-settings"></a></h3>
<table class="table"><thead><tr><th>Period</th>
<th>Cell Levels</th>
<th>Smoothing</th>
<th>Min Cell Size</th>
</tr></thead><tbody><tr><td>Month</td>
<td>4 (full hierarchy)</td>
<td>3-period rolling mean</td>
<td>10</td>
</tr><tr><td>Fortnight</td>
<td>2 (age + region)</td>
<td>7-period rolling mean</td>
<td>10</td>
</tr><tr><td>Week</td>
<td>1 (age only)</td>
<td>None</td>
<td>10</td>
</tr></tbody></table><p>Cell levels are auto-selected based on <code>calibration_unit</code> parameter. Levels with cells smaller than <code>min_cell_size</code> are skipped.</p>
</div>
<div class="section level3">
<h3 id="calibration-cell-hierarchy">Calibration Cell Hierarchy<a class="anchor" aria-label="anchor" href="#calibration-cell-hierarchy"></a></h3>
<ol style="list-style-type: decimal"><li>
<strong>celula1:</strong> Age groups (0-13, 14-29, 30-59, 60+)</li>
<li>
<strong>celula2:</strong> Post-stratum group (posest_sxi) + age</li>
<li>
<strong>celula3:</strong> State (UF) + celula2</li>
<li>
<strong>celula4:</strong> Post-stratum (posest) + celula2</li>
</ol></div>
<div class="section level3">
<h3 id="anchor-types">Anchor Types<a class="anchor" aria-label="anchor" href="#anchor-types"></a></h3>
<ul><li>
<code>anchor = "quarter"</code>: Preserve quarterly totals, redistribute to sub-periods (use with V1028)</li>
<li>
<code>anchor = "year"</code>: Preserve annual totals (for annual PNADC data with V1032 weights)</li>
</ul></div>
<div class="section level3">
<h3 id="output-weight-columns">Output Weight Columns<a class="anchor" aria-label="anchor" href="#output-weight-columns"></a></h3>
<ul><li>
<code>weight_monthly</code>: Calibrated monthly weight (when <code>calibration_unit = "month"</code>)</li>
<li>
<code>weight_fortnight</code>: Calibrated fortnight weight (when <code>calibration_unit = "fortnight"</code>)</li>
<li>
<code>weight_weekly</code>: Calibrated weekly weight (when <code>calibration_unit = "week"</code>)</li>
</ul></div>
</div>
<div class="section level2">
<h2 id="performance-optimizations">Performance Optimizations<a class="anchor" aria-label="anchor" href="#performance-optimizations"></a></h2>
<p>The package is optimized for large datasets (~450,000 rows/sec):</p>
<ol style="list-style-type: decimal"><li>
<strong>Lookup tables:</strong> Pre-computed date tables for 20x faster date creation vs <code><a href="https://rdrr.io/r/base/ISOdatetime.html" class="external-link">ISOdate()</a></code>
</li>
<li>
<strong>Integer arithmetic:</strong> ISO week calculations use pure integer math (300x faster than <code><a href="https://rdrr.io/pkg/data.table/man/IDateTime.html" class="external-link">data.table::isoweek()</a></code>)</li>
<li>
<strong>data.table threading:</strong> Enabled via <code>setDTthreads(0)</code> at package load</li>
<li>
<strong>Vectorized operations:</strong> All calculations use vectorized data.table syntax</li>
<li>
<strong>Efficient joins:</strong> data.table binary joins instead of <code><a href="https://rdrr.io/r/base/merge.html" class="external-link">merge()</a></code>
</li>
</ol></div>
<div class="section level2">
<h2 id="sidra-series-mensalization-1">SIDRA Series Mensalization<a class="anchor" aria-label="anchor" href="#sidra-series-mensalization-1"></a></h2>
<p>The package provides functions to convert IBGE’s rolling quarterly (trimestre móvel) aggregate series to exact monthly estimates.</p>
<div class="section level3">
<h3 id="mathematical-foundation">Mathematical Foundation<a class="anchor" aria-label="anchor" href="#mathematical-foundation"></a></h3>
<p>Rolling quarters are 3-month moving averages. The relationship:</p>
<pre><code>RQ_t - RQ_{t-1} = (Month_t - Month_{t-3}) / 3</code></pre>
<p>This allows recovery of exact monthly values given starting points.</p>
</div>
<div class="section level3">
<h3 id="algorithm-steps">Algorithm Steps<a class="anchor" aria-label="anchor" href="#algorithm-steps"></a></h3>
<ol style="list-style-type: decimal"><li>Fetch rolling quarters from SIDRA API</li>
<li>Calculate <code>d3 = 3 × (RQ_t - RQ_{t-1})</code>
</li>
<li>Separate d3 by month position in quarter (mesnotrim 1, 2, 3)</li>
<li>Cumulate separately: <code>cum1</code>, <code>cum2</code>, <code>cum3</code>
</li>
<li>Apply starting points: <code>y = y0 + cum</code>
</li>
<li>Final adjustment for rolling quarter consistency</li>
</ol></div>
<div class="section level3">
<h3 id="starting-points">Starting Points<a class="anchor" aria-label="anchor" href="#starting-points"></a></h3>
<ul><li>Pre-computed for 53 series from 2013-2019 microdata</li>
<li>Bundled in <code>pnadc_series_starting_points</code> dataset</li>
<li>Users can compute custom starting points via <code><a href="reference/compute_starting_points_from_microdata.html">compute_starting_points_from_microdata()</a></code>
</li>
</ul></div>
<div class="section level3">
<h3 id="available-series">Available Series<a class="anchor" aria-label="anchor" href="#available-series"></a></h3>
<p>86+ series across themes: - <strong>labor_market</strong>: Employment, unemployment, participation rates - <strong>earnings</strong>: Wages, income by category - <strong>demographics</strong>: Population components - <strong>social_protection</strong>: Pension coverage - <strong>prices</strong>: Deflated series</p>
</div>
<div class="section level3">
<h3 id="caching">Caching<a class="anchor" aria-label="anchor" href="#caching"></a></h3>
<p>Unified cache infrastructure with optional expiration: - Rolling quarters and population data cached in <code>.sidra_cache</code> environment - <code><a href="reference/clear_sidra_cache.html">clear_sidra_cache()</a></code> to force fresh download</p>
</div>
</div>
<div class="section level2">
<h2 id="dependencies">Dependencies<a class="anchor" aria-label="anchor" href="#dependencies"></a></h2>
<p><strong>Required:</strong> - <code>data.table</code> (&gt;= 1.14.0) - Core data manipulation - <code>checkmate</code> (&gt;= 2.0.0) - Input validation - <code>sidrar</code> (&gt;= 0.2.9) - SIDRA API access for population and series data - <code>lubridate</code> (&gt;= 1.9.4) - Date/time utilities</p>
<p><strong>Suggested:</strong> - <code>dplyr</code> - Alternative data manipulation - <code>haven</code> - Read SAS/SPSS/Stata files - <code>testthat</code> (&gt;= 3.0.0) - Testing - <code>knitr</code>, <code>rmarkdown</code> - Vignettes - <code>pkgdown</code> - Website - <code>ggplot2</code>, <code>scales</code> - Visualization</p>
</div>
<div class="section level2">
<h2 id="workflow-examples">Workflow Examples<a class="anchor" aria-label="anchor" href="#workflow-examples"></a></h2>
<div class="section level3">
<h3 id="standard-monthly-analysis">Standard Monthly Analysis<a class="anchor" aria-label="anchor" href="#standard-monthly-analysis"></a></h3>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Build crosswalk from stacked multi-year data (maximizes determination rate)</span></span>
<span><span class="va">crosswalk</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/pnadc_identify_periods.html">pnadc_identify_periods</a></span><span class="op">(</span><span class="va">pnadc_stacked</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Apply to specific quarter with calibration</span></span>
<span><span class="va">result</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/pnadc_apply_periods.html">pnadc_apply_periods</a></span><span class="op">(</span><span class="va">pnadc_2023</span>, <span class="va">crosswalk</span>,</span>
<span>                              weight_var <span class="op">=</span> <span class="st">"V1028"</span>,</span>
<span>                              anchor <span class="op">=</span> <span class="st">"quarter"</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="annual-data">Annual Data<a class="anchor" aria-label="anchor" href="#annual-data"></a></h3>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">result</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/pnadc_apply_periods.html">pnadc_apply_periods</a></span><span class="op">(</span><span class="va">pnadc_annual</span>, <span class="va">crosswalk</span>,</span>
<span>                              weight_var <span class="op">=</span> <span class="st">"V1032"</span>,</span>
<span>                              anchor <span class="op">=</span> <span class="st">"year"</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="crosswalk-only-no-calibration">Crosswalk Only (No Calibration)<a class="anchor" aria-label="anchor" href="#crosswalk-only-no-calibration"></a></h3>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">result</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/pnadc_apply_periods.html">pnadc_apply_periods</a></span><span class="op">(</span><span class="va">pnadc_2023</span>, <span class="va">crosswalk</span>,</span>
<span>                              calibrate <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="experimental-period-assignment">Experimental Period Assignment<a class="anchor" aria-label="anchor" href="#experimental-period-assignment"></a></h3>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Build standard crosswalk (with date bounds for probabilistic strategy)</span></span>
<span><span class="va">crosswalk</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/pnadc_identify_periods.html">pnadc_identify_periods</a></span><span class="op">(</span><span class="va">pnadc_data</span>, store_date_bounds <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Apply experimental strategies for additional assignments</span></span>
<span><span class="va">crosswalk_exp</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/pnadc_experimental_periods.html">pnadc_experimental_periods</a></span><span class="op">(</span></span>
<span>  <span class="va">crosswalk</span>,</span>
<span>  strategy <span class="op">=</span> <span class="st">"both"</span>,  <span class="co"># probabilistic + UPA aggregation</span></span>
<span>  confidence_threshold <span class="op">=</span> <span class="fl">0.9</span>,</span>
<span>  upa_proportion_threshold <span class="op">=</span> <span class="fl">0.5</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Use directly with calibration</span></span>
<span><span class="va">result</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/pnadc_apply_periods.html">pnadc_apply_periods</a></span><span class="op">(</span><span class="va">pnadc_data</span>, <span class="va">crosswalk_exp</span>,</span>
<span>                              weight_var <span class="op">=</span> <span class="st">"V1028"</span>,</span>
<span>                              anchor <span class="op">=</span> <span class="st">"quarter"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Filter to strict-only if needed</span></span>
<span><span class="va">strict_only</span> <span class="op">&lt;-</span> <span class="va">crosswalk_exp</span><span class="op">[</span><span class="va">probabilistic_assignment</span> <span class="op">==</span> <span class="cn">FALSE</span> <span class="op">|</span> <span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">probabilistic_assignment</span><span class="op">)</span><span class="op">]</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="sidra-series-mensalization-2">SIDRA Series Mensalization<a class="anchor" aria-label="anchor" href="#sidra-series-mensalization-2"></a></h3>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Fetch rolling quarterly data from SIDRA</span></span>
<span><span class="va">rolling</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/fetch_sidra_rolling_quarters.html">fetch_sidra_rolling_quarters</a></span><span class="op">(</span>theme <span class="op">=</span> <span class="st">"labor_market"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Convert to exact monthly estimates</span></span>
<span><span class="va">monthly</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/mensalize_sidra_series.html">mensalize_sidra_series</a></span><span class="op">(</span><span class="va">rolling</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># View available series</span></span>
<span><span class="fu"><a href="reference/get_sidra_series_metadata.html">get_sidra_series_metadata</a></span><span class="op">(</span>theme <span class="op">=</span> <span class="st">"labor_market"</span><span class="op">)</span></span></code></pre></div>
</div>
</div>
<div class="section level2">
<h2 id="required-pnadc-variables">Required PNADC Variables<a class="anchor" aria-label="anchor" href="#required-pnadc-variables"></a></h2>
<div class="section level3">
<h3 id="for-period-identification">For Period Identification<a class="anchor" aria-label="anchor" href="#for-period-identification"></a></h3>
<ul><li>
<code>Ano</code> - Survey year</li>
<li>
<code>Trimestre</code> - Quarter (1-4)</li>
<li>
<code>UPA</code> - Primary sampling unit</li>
<li>
<code>V1008</code> - Household sequence number</li>
<li>
<code>V1014</code> - Panel group (1-8)</li>
<li>
<code>V2008</code> - Birth day (1-31, 99=unknown)</li>
<li>
<code>V20081</code> - Birth month (1-12, 99=unknown)</li>
<li>
<code>V20082</code> - Birth year</li>
<li>
<code>V2009</code> - Age</li>
</ul></div>
<div class="section level3">
<h3 id="for-weight-calibration-additional">For Weight Calibration (additional)<a class="anchor" aria-label="anchor" href="#for-weight-calibration-additional"></a></h3>
<ul><li>
<code>V1028</code> - Quarterly weight (for quarterly data)</li>
<li>
<code>V1032</code> - Annual weight (for annual data)</li>
<li>
<code>UF</code> - State code</li>
<li>
<code>posest</code> - Post-stratum</li>
<li>
<code>posest_sxi</code> - Post-stratum group</li>
</ul></div>
</div>
</div>

  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside></div>


    <footer><div class="pkgdown-footer-left">
  <p>Developed by <a href="https://orcid.org/0000-0002-6796-4547" class="external-link">Rogerio Barbosa</a>, <a href="https://orcid.org/0000-0002-5449-6787" class="external-link">Marcos Hecksher</a>.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.3.</p>
</div>

    </footer></div>





  </body></html>

