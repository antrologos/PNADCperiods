<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Complex Survey Design with Monthly Weights • PNADCperiods</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Complex Survey Design with Monthly Weights">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-primary" data-bs-theme="dark" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">PNADCperiods</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.1.0</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../articles/getting-started.html">Get Started</a></li>
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/download-and-prepare.html">Download and Prepare Data</a></li>
    <li><a class="dropdown-item" href="../articles/applied-examples.html">Applied Examples</a></li>
    <li><a class="dropdown-item" href="../articles/annual-poverty-analysis.html">Annual Poverty Analysis</a></li>
    <li><a class="dropdown-item" href="../articles/complex-survey-design.html">Complex Survey Design</a></li>
    <li><a class="dropdown-item" href="../articles/how-it-works.html">How PNADCperiods Works</a></li>
    <li><hr class="dropdown-divider"></li>
    <li><a class="dropdown-item" href="../articles/sidra-mensalization.html">SIDRA Mensalization Guide</a></li>
  </ul>
</li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/antrologos/PNADCperiods/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>Complex Survey Design with Monthly Weights</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/antrologos/PNADCperiods/blob/HEAD/vignettes/complex-survey-design.Rmd" class="external-link"><code>vignettes/complex-survey-design.Rmd</code></a></small>
      <div class="d-none name"><code>complex-survey-design.Rmd</code></div>
    </div>

    
    
<!--
MAINTAINER NOTE:
The code chunks in this vignette must match the code in:
  mensalizacao_pnad/code/generate_complex_survey_figures.R

Look for comments like "# --- VIGNETTE CODE: chunk-name ---" in that script.
To regenerate figures, run that script. Changes to code here
must be mirrored in the generation script (and vice versa).
-->
<div class="section level2">
<h2 id="introduction">Introduction<a class="anchor" aria-label="anchor" href="#introduction"></a>
</h2>
<p>When you compute a statistic from survey data—say, the unemployment
rate is 7.2%—that number alone doesn’t tell you much. Is 7.2%
meaningfully different from last month’s 7.0%? Without <strong>standard
errors</strong> and <strong>confidence intervals</strong>, you can’t
answer this question.</p>
<p>This matters especially when tracking changes over time. Monthly data
from <code>PNADCperiods</code> reveals dynamics hidden in quarterly
averages, but those sharp month-to-month movements could be real
economic changes or just sampling variability. Standard errors let you
distinguish signal from noise.</p>
<p>The challenge is that PNADC uses a <strong>complex sample
design</strong>—stratification (<code>Estrato</code>), clustering
(<code>UPA</code>), and unequal probabilities—which means standard
formulas underestimate variance. This vignette shows two strategies for
proper variance estimation:</p>
<ol style="list-style-type: decimal">
<li>
<strong>Linearization</strong>: Using design variables
directly—simple and fast</li>
<li>
<strong>Replication weights</strong>: Adjusting IBGE’s 200 bootstrap
weights—more intensive but exact</li>
</ol>
<p>We demonstrate both using the <strong>gender gap in labor force
participation</strong>, which widened dramatically during COVID-19.</p>
<hr>
</div>
<div class="section level2">
<h2 id="why-standard-errors-matter">Why Standard Errors Matter<a class="anchor" aria-label="anchor" href="#why-standard-errors-matter"></a>
</h2>
<p>Before diving into methodology, consider the figure below. It shows
labor force participation for men and women during COVID-19. The
<strong>shaded bands</strong> are 95% confidence intervals from proper
complex survey analysis.</p>
<details><summary>
Show plotting code
</summary><div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Subset to COVID period for focused visualization</span></span>
<span><span class="va">p3_data</span> <span class="op">&lt;-</span> <span class="va">results_by_sex</span><span class="op">[</span><span class="va">period</span> <span class="op">&gt;=</span> <span class="st">"2019-01-01"</span> <span class="op">&amp;</span> <span class="va">period</span> <span class="op">&lt;=</span> <span class="st">"2022-06-01"</span><span class="op">]</span></span>
<span></span>
<span><span class="va">p3</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">p3_data</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">period</span>, y <span class="op">=</span> <span class="va">participation</span>, color <span class="op">=</span> <span class="va">sex</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span></span>
<span>  <span class="co"># Just the lines (no CI)</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span>linewidth <span class="op">=</span> <span class="fl">0.9</span><span class="op">)</span> <span class="op">+</span></span>
<span></span>
<span>  <span class="co"># Add confidence bands with low alpha</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_ribbon.html" class="external-link">geom_ribbon</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>ymin <span class="op">=</span> <span class="va">ci_l</span>, ymax <span class="op">=</span> <span class="va">ci_u</span>, fill <span class="op">=</span> <span class="va">sex</span><span class="op">)</span>,</span>
<span>              alpha <span class="op">=</span> <span class="fl">0.25</span>, color <span class="op">=</span> <span class="cn">NA</span><span class="op">)</span> <span class="op">+</span></span>
<span></span>
<span>  <span class="co"># Scales and labels</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html" class="external-link">scale_y_continuous</a></span><span class="op">(</span></span>
<span>    labels <span class="op">=</span> <span class="fu"><a href="https://scales.r-lib.org/reference/percent_format.html" class="external-link">percent_format</a></span><span class="op">(</span>accuracy <span class="op">=</span> <span class="fl">1</span><span class="op">)</span>,</span>
<span>    limits <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.45</span>, <span class="fl">0.80</span><span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_date.html" class="external-link">scale_x_date</a></span><span class="op">(</span>date_breaks <span class="op">=</span> <span class="st">"6 months"</span>, date_labels <span class="op">=</span> <span class="st">"%b\n%Y"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_manual.html" class="external-link">scale_color_manual</a></span><span class="op">(</span>values <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Men"</span> <span class="op">=</span> <span class="st">"#0074D9"</span>, <span class="st">"Women"</span> <span class="op">=</span> <span class="st">"#FF4136"</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_manual.html" class="external-link">scale_fill_manual</a></span><span class="op">(</span>values <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Men"</span> <span class="op">=</span> <span class="st">"#0074D9"</span>, <span class="st">"Women"</span> <span class="op">=</span> <span class="st">"#FF4136"</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span></span>
<span>  <span class="co"># Add annotations for interpretation</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/annotate.html" class="external-link">annotate</a></span><span class="op">(</span><span class="st">"segment"</span>,</span>
<span>           x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/as.Date.html" class="external-link">as.Date</a></span><span class="op">(</span><span class="st">"2020-06-15"</span><span class="op">)</span>, xend <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/as.Date.html" class="external-link">as.Date</a></span><span class="op">(</span><span class="st">"2020-06-15"</span><span class="op">)</span>,</span>
<span>           y <span class="op">=</span> <span class="fl">0.52</span>, yend <span class="op">=</span> <span class="fl">0.62</span>,</span>
<span>           arrow <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/grid/arrow.html" class="external-link">arrow</a></span><span class="op">(</span>ends <span class="op">=</span> <span class="st">"both"</span>, length <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/grid/unit.html" class="external-link">unit</a></span><span class="op">(</span><span class="fl">0.1</span>, <span class="st">"cm"</span><span class="op">)</span><span class="op">)</span>,</span>
<span>           color <span class="op">=</span> <span class="st">"gray30"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/annotate.html" class="external-link">annotate</a></span><span class="op">(</span><span class="st">"text"</span>,</span>
<span>           x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/as.Date.html" class="external-link">as.Date</a></span><span class="op">(</span><span class="st">"2020-06-15"</span><span class="op">)</span>, y <span class="op">=</span> <span class="fl">0.50</span>,</span>
<span>           label <span class="op">=</span> <span class="st">"Is this drop\nstatistically\nsignificant?"</span>,</span>
<span>           size <span class="op">=</span> <span class="fl">2.8</span>, color <span class="op">=</span> <span class="st">"gray30"</span><span class="op">)</span> <span class="op">+</span></span>
<span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span></span>
<span>    title <span class="op">=</span> <span class="st">"Why Confidence Intervals Matter: COVID-19 Labor Market Shock"</span>,</span>
<span>    subtitle <span class="op">=</span> <span class="st">"Confidence bands (shaded) show the precision of estimates. Overlapping bands suggest uncertain differences."</span>,</span>
<span>    x <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>    y <span class="op">=</span> <span class="st">"Labor Force Participation Rate"</span>,</span>
<span>    color <span class="op">=</span> <span class="st">"Sex"</span>,</span>
<span>    fill <span class="op">=</span> <span class="st">"Sex"</span>,</span>
<span>    caption <span class="op">=</span> <span class="st">"Source: PNADC/IBGE. Confidence bands show +/- 1.96 SE from complex survey design."</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_minimal</a></span><span class="op">(</span>base_size <span class="op">=</span> <span class="fl">11</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span></span>
<span>    plot.title <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_text</a></span><span class="op">(</span>face <span class="op">=</span> <span class="st">"bold"</span><span class="op">)</span>,</span>
<span>    legend.position <span class="op">=</span> <span class="st">"bottom"</span>,</span>
<span>    panel.grid.minor <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_blank</a></span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span><span class="va">p3</span></span></code></pre></div>
</details><div class="float">
<img src="figures/complex-survey-design/fig-why-se-matter.png" style="width:100.0%" alt="Why Confidence Intervals Matter: COVID-19 Labor Market Shock"><div class="figcaption">Why Confidence Intervals Matter: COVID-19 Labor
Market Shock</div>
</div>
<p>Without confidence intervals, we might over-interpret month-to-month
fluctuations as real economic changes. With them, we can assess which
movements are statistically meaningful.</p>
<hr>
</div>
<div class="section level2">
<h2 id="prerequisites">Prerequisites<a class="anchor" aria-label="anchor" href="#prerequisites"></a>
</h2>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Core packages</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://antrologos.github.io/PNADCperiods/">PNADCperiods</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://r-datatable.com" class="external-link">data.table</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="http://www.fstpackage.org" class="external-link">fst</a></span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Survey analysis</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="http://r-survey.r-forge.r-project.org/survey/" class="external-link">survey</a></span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Visualization</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org" class="external-link">ggplot2</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://scales.r-lib.org" class="external-link">scales</a></span><span class="op">)</span></span></code></pre></div>
<hr>
</div>
<div class="section level2">
<h2 id="loading-and-preparing-data">Loading and Preparing Data<a class="anchor" aria-label="anchor" href="#loading-and-preparing-data"></a>
</h2>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Load stacked PNADC quarterly data (all years available)</span></span>
<span><span class="co"># Requires: identification vars, calibration vars, Estrato, plus analysis vars</span></span>
<span><span class="va">files</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.files.html" class="external-link">list.files</a></span><span class="op">(</span><span class="st">"D:/Dropbox/Bancos_Dados/PNADC/Trimestral/Dados/"</span>,</span>
<span>                    pattern <span class="op">=</span> <span class="st">"^pnadc_\\d{4}-\\dq\\.fst$"</span>, full.names <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span></span>
<span><span class="va">cols_needed</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span></span>
<span>  <span class="co"># Mensalization keys</span></span>
<span>  <span class="st">"Ano"</span>, <span class="st">"Trimestre"</span>, <span class="st">"UPA"</span>, <span class="st">"V1008"</span>, <span class="st">"V1014"</span>,</span>
<span>  <span class="co"># Birthday variables (for identification)</span></span>
<span>  <span class="st">"V2008"</span>, <span class="st">"V20081"</span>, <span class="st">"V20082"</span>, <span class="st">"V2009"</span>,</span>
<span>  <span class="co"># Calibration variables</span></span>
<span>  <span class="st">"V1028"</span>, <span class="st">"UF"</span>, <span class="st">"posest"</span>, <span class="st">"posest_sxi"</span>,</span>
<span>  <span class="co"># Survey design variables</span></span>
<span>  <span class="st">"Estrato"</span>,</span>
<span>  <span class="co"># Analysis variables</span></span>
<span>  <span class="st">"VD4001"</span>, <span class="st">"VD4002"</span>, <span class="st">"V2007"</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">pnadc</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/data.table/man/rbindlist.html" class="external-link">rbindlist</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="va">files</span>, <span class="kw">function</span><span class="op">(</span><span class="va">f</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu">fst</span><span class="fu">::</span><span class="fu"><a href="http://www.fstpackage.org/reference/write_fst.html" class="external-link">read_fst</a></span><span class="op">(</span><span class="va">f</span>, as.data.table <span class="op">=</span> <span class="cn">TRUE</span>, columns <span class="op">=</span> <span class="va">cols_needed</span><span class="op">)</span></span>
<span><span class="op">}</span><span class="op">)</span>, fill <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Step 1: Build crosswalk (identify reference periods)</span></span>
<span><span class="va">crosswalk</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/pnadc_identify_periods.html">pnadc_identify_periods</a></span><span class="op">(</span><span class="va">pnadc</span>, verbose <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Step 2: Apply crosswalk and calibrate weights</span></span>
<span><span class="va">pnadc</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/pnadc_apply_periods.html">pnadc_apply_periods</a></span><span class="op">(</span><span class="va">pnadc</span>, <span class="va">crosswalk</span>,</span>
<span>                              weight_var <span class="op">=</span> <span class="st">"V1028"</span>,</span>
<span>                              anchor <span class="op">=</span> <span class="st">"quarter"</span>,</span>
<span>                              calibrate <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>                              calibration_unit <span class="op">=</span> <span class="st">"month"</span>,</span>
<span>                              verbose <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Filter to determined observations with monthly weights</span></span>
<span><span class="va">pnadc_monthly</span> <span class="op">&lt;-</span> <span class="va">pnadc</span><span class="op">[</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">weight_monthly</span><span class="op">)</span><span class="op">]</span></span>
<span></span>
<span><span class="co"># Handle singleton strata globally</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/options.html" class="external-link">options</a></span><span class="op">(</span>survey.lonely.psu <span class="op">=</span> <span class="st">"adjust"</span><span class="op">)</span></span></code></pre></div>
<hr>
</div>
<div class="section level2">
<h2 id="strategy-1-linearization-with-strata-and-psu">Strategy 1: Linearization with Strata and PSU<a class="anchor" aria-label="anchor" href="#strategy-1-linearization-with-strata-and-psu"></a>
</h2>
<p>This approach uses <strong>Taylor series linearization</strong> to
estimate variances. PNADC uses a two-stage stratified cluster sample:
within each stratum (<code>Estrato</code>), Primary Sampling Units
(<code>UPA</code>) are selected with probability proportional to size,
then households within selected UPAs are interviewed.</p>
<div class="section level3">
<h3 id="setting-up-a-survey-design">Setting Up a Survey Design<a class="anchor" aria-label="anchor" href="#setting-up-a-survey-design"></a>
</h3>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Create survey design object for a specific month (e.g., January 2020)</span></span>
<span><span class="va">pnadc_jan2020</span> <span class="op">&lt;-</span> <span class="va">pnadc_monthly</span><span class="op">[</span><span class="va">ref_month_yyyymm</span> <span class="op">==</span> <span class="fl">202001</span> <span class="op">&amp;</span> <span class="va">V2009</span> <span class="op">&gt;=</span> <span class="fl">14</span><span class="op">]</span></span>
<span></span>
<span><span class="va">design_jan2020</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/survey/man/svydesign.html" class="external-link">svydesign</a></span><span class="op">(</span></span>
<span>  ids <span class="op">=</span> <span class="op">~</span><span class="va">UPA</span>,                    <span class="co"># PSU/cluster identifier</span></span>
<span>  strata <span class="op">=</span> <span class="op">~</span><span class="va">Estrato</span>,             <span class="co"># Stratification variable</span></span>
<span>  weights <span class="op">=</span> <span class="op">~</span><span class="va">weight_monthly</span>,     <span class="co"># Monthly-adjusted weight</span></span>
<span>  data <span class="op">=</span> <span class="va">pnadc_jan2020</span>,</span>
<span>  nest <span class="op">=</span> <span class="cn">TRUE</span>                    <span class="co"># UPAs nested within strata</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Labor force participation rate</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/survey/man/surveysummary.html" class="external-link">svymean</a></span><span class="op">(</span><span class="op">~</span><span class="fu"><a href="https://rdrr.io/r/base/AsIs.html" class="external-link">I</a></span><span class="op">(</span><span class="va">VD4001</span> <span class="op">==</span> <span class="fl">1</span><span class="op">)</span>, <span class="va">design_jan2020</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/stats/confint.html" class="external-link">confint</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/survey/man/surveysummary.html" class="external-link">svymean</a></span><span class="op">(</span><span class="op">~</span><span class="fu"><a href="https://rdrr.io/r/base/AsIs.html" class="external-link">I</a></span><span class="op">(</span><span class="va">VD4001</span> <span class="op">==</span> <span class="fl">1</span><span class="op">)</span>, <span class="va">design_jan2020</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="monthly-time-series-with-confidence-intervals">Monthly Time Series with Confidence Intervals<a class="anchor" aria-label="anchor" href="#monthly-time-series-with-confidence-intervals"></a>
</h3>
<p>To create a full monthly series, loop over months with a function
that handles edge cases:</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Prepare analysis data</span></span>
<span><span class="va">pnadc_monthly</span><span class="op">[</span>, <span class="va">V2009</span> <span class="op">:=</span> <span class="fu"><a href="https://rdrr.io/r/base/integer.html" class="external-link">as.integer</a></span><span class="op">(</span><span class="va">V2009</span><span class="op">)</span><span class="op">]</span></span>
<span><span class="va">pnadc_analysis</span> <span class="op">&lt;-</span> <span class="va">pnadc_monthly</span><span class="op">[</span><span class="va">V2009</span> <span class="op">&gt;=</span> <span class="fl">14</span><span class="op">]</span></span>
<span><span class="va">pnadc_analysis</span><span class="op">[</span>, <span class="va">VD4001</span> <span class="op">:=</span> <span class="fu"><a href="https://rdrr.io/r/base/integer.html" class="external-link">as.integer</a></span><span class="op">(</span><span class="va">VD4001</span><span class="op">)</span><span class="op">]</span></span>
<span><span class="va">pnadc_analysis</span><span class="op">[</span>, <span class="va">in_labor_force</span> <span class="op">:=</span> <span class="fu"><a href="https://rdrr.io/pkg/data.table/man/fifelse.html" class="external-link">fifelse</a></span><span class="op">(</span><span class="va">VD4001</span> <span class="op">==</span> <span class="fl">1</span>, <span class="fl">1L</span>, <span class="fl">0L</span><span class="op">)</span><span class="op">]</span></span>
<span><span class="va">pnadc_analysis</span><span class="op">[</span>, <span class="va">V2007</span> <span class="op">:=</span> <span class="fu"><a href="https://rdrr.io/r/base/integer.html" class="external-link">as.integer</a></span><span class="op">(</span><span class="va">V2007</span><span class="op">)</span><span class="op">]</span></span>
<span><span class="va">pnadc_analysis</span><span class="op">[</span>, <span class="va">sex</span> <span class="op">:=</span> <span class="fu"><a href="https://rdrr.io/pkg/data.table/man/fifelse.html" class="external-link">fifelse</a></span><span class="op">(</span><span class="va">V2007</span> <span class="op">==</span> <span class="fl">1</span>, <span class="st">"Men"</span>, <span class="st">"Women"</span><span class="op">)</span><span class="op">]</span></span>
<span></span>
<span><span class="co"># Function to compute participation by sex for one month</span></span>
<span><span class="va">compute_participation_by_sex</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">month_yyyymm</span>, <span class="va">data</span><span class="op">)</span> <span class="op">{</span></span>
<span></span>
<span>  <span class="va">month_data</span> <span class="op">&lt;-</span> <span class="va">data</span><span class="op">[</span><span class="va">ref_month_yyyymm</span> <span class="op">==</span> <span class="va">month_yyyymm</span><span class="op">]</span></span>
<span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">month_data</span><span class="op">)</span> <span class="op">&lt;</span> <span class="fl">100</span><span class="op">)</span> <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="cn">NULL</span><span class="op">)</span></span>
<span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/conditions.html" class="external-link">tryCatch</a></span><span class="op">(</span><span class="op">{</span></span>
<span>    <span class="va">design</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/survey/man/svydesign.html" class="external-link">svydesign</a></span><span class="op">(</span></span>
<span>      ids <span class="op">=</span> <span class="op">~</span><span class="va">UPA</span>,</span>
<span>      strata <span class="op">=</span> <span class="op">~</span><span class="va">Estrato</span>,</span>
<span>      weights <span class="op">=</span> <span class="op">~</span><span class="va">weight_monthly</span>,</span>
<span>      data <span class="op">=</span> <span class="va">month_data</span>,</span>
<span>      nest <span class="op">=</span> <span class="cn">TRUE</span></span>
<span>    <span class="op">)</span></span>
<span></span>
<span>    <span class="va">result</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/survey/man/svyby.html" class="external-link">svyby</a></span><span class="op">(</span></span>
<span>      <span class="op">~</span><span class="va">in_labor_force</span>,</span>
<span>      by <span class="op">=</span> <span class="op">~</span><span class="va">sex</span>,</span>
<span>      design <span class="op">=</span> <span class="va">design</span>,</span>
<span>      FUN <span class="op">=</span> <span class="va">svymean</span>,</span>
<span>      na.rm <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>      vartype <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"se"</span>, <span class="st">"ci"</span><span class="op">)</span></span>
<span>    <span class="op">)</span></span>
<span></span>
<span>    <span class="fu"><a href="https://rdrr.io/pkg/data.table/man/setDT.html" class="external-link">setDT</a></span><span class="op">(</span><span class="va">result</span><span class="op">)</span></span>
<span>    <span class="va">result</span><span class="op">[</span>, <span class="va">ref_month_yyyymm</span> <span class="op">:=</span> <span class="va">month_yyyymm</span><span class="op">]</span></span>
<span>    <span class="va">result</span></span>
<span>  <span class="op">}</span>, error <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">e</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"Error processing month"</span>, <span class="va">month_yyyymm</span>, <span class="st">":"</span>, <span class="va">e</span><span class="op">$</span><span class="va">message</span>, <span class="st">"\n"</span><span class="op">)</span></span>
<span>    <span class="cn">NULL</span></span>
<span>  <span class="op">}</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># Compute for all months</span></span>
<span><span class="va">months</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sort.html" class="external-link">sort</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="va">pnadc_analysis</span><span class="op">$</span><span class="va">ref_month_yyyymm</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">results_by_sex</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/data.table/man/rbindlist.html" class="external-link">rbindlist</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="va">months</span>, <span class="va">compute_participation_by_sex</span>, data <span class="op">=</span> <span class="va">pnadc_analysis</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Rename estimate column for clarity</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/data.table/man/setattr.html" class="external-link">setnames</a></span><span class="op">(</span><span class="va">results_by_sex</span>, <span class="st">"in_labor_force"</span>, <span class="st">"participation"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Add date column for plotting</span></span>
<span><span class="va">results_by_sex</span><span class="op">[</span>, <span class="va">period</span> <span class="op">:=</span> <span class="fu"><a href="https://rdrr.io/r/base/as.Date.html" class="external-link">as.Date</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span></span>
<span>  <span class="va">ref_month_yyyymm</span> <span class="op"><a href="https://rdrr.io/r/base/Arithmetic.html" class="external-link">%/%</a></span> <span class="fl">100</span>, <span class="st">"-"</span>,</span>
<span>  <span class="va">ref_month_yyyymm</span> <span class="op"><a href="https://rdrr.io/r/base/Arithmetic.html" class="external-link">%%</a></span> <span class="fl">100</span>, <span class="st">"-15"</span></span>
<span><span class="op">)</span><span class="op">)</span><span class="op">]</span></span></code></pre></div>
<p>The <code>tryCatch</code> wrapper handles months where the survey
design might fail (e.g., sparse data in early pandemic months). The
<code><a href="https://rdrr.io/pkg/survey/man/svyby.html" class="external-link">svyby()</a></code> function returns columns
<code>participation</code>, <code>se</code>, <code>ci_l</code>, and
<code>ci_u</code>.</p>
<hr>
</div>
</div>
<div class="section level2">
<h2 id="strategy-2-replication-weights">Strategy 2: Replication Weights<a class="anchor" aria-label="anchor" href="#strategy-2-replication-weights"></a>
</h2>
<p>IBGE provides 200 <strong>bootstrap replication weights</strong>
(<code>V1028001</code> to <code>V1028200</code>) with each quarterly
release. This approach is more computationally intensive (201
computations per statistic) but handles complex statistics like
quantiles, Gini coefficients, and regression coefficients without
special variance formulas.</p>
<p>The key insight: apply the <strong>same calibration ratio</strong> to
each replication weight:</p>
<p><math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msubsup><mtext mathvariant="normal">V1028</mtext><mi>k</mi><mtext mathvariant="normal">monthly</mtext></msubsup><mo>=</mo><msub><mtext mathvariant="normal">V1028</mtext><mi>k</mi></msub><mo>×</mo><mfrac><mtext mathvariant="normal">weight_monthly</mtext><mtext mathvariant="normal">V1028</mtext></mfrac></mrow><annotation encoding="application/x-tex">
\text{V1028}_k^{\text{monthly}} = \text{V1028}_k \times \frac{\text{weight\_monthly}}{\text{V1028}}
</annotation></semantics></math></p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Calculate the adjustment ratio</span></span>
<span><span class="va">pnadc_monthly</span><span class="op">[</span>, <span class="va">weight_ratio</span> <span class="op">:=</span> <span class="va">weight_monthly</span> <span class="op">/</span> <span class="va">V1028</span><span class="op">]</span></span>
<span></span>
<span><span class="co"># Get names of replication weight columns</span></span>
<span><span class="va">rep_weight_cols</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"V1028"</span>, <span class="fu"><a href="https://rdrr.io/r/base/sprintf.html" class="external-link">sprintf</a></span><span class="op">(</span><span class="st">"%03d"</span>, <span class="fl">1</span><span class="op">:</span><span class="fl">200</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Create adjusted replication weight columns</span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">col</span> <span class="kw">in</span> <span class="va">rep_weight_cols</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">new_col</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">col</span>, <span class="st">"_monthly"</span><span class="op">)</span></span>
<span>  <span class="va">pnadc_monthly</span><span class="op">[</span>, <span class="op">(</span><span class="va">new_col</span><span class="op">)</span> <span class="op">:=</span> <span class="fu"><a href="https://rdrr.io/r/base/get.html" class="external-link">get</a></span><span class="op">(</span><span class="va">col</span><span class="op">)</span> <span class="op">*</span> <span class="va">weight_ratio</span><span class="op">]</span></span>
<span><span class="op">}</span></span></code></pre></div>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Create replicate weights design (e.g., for January 2020)</span></span>
<span><span class="va">pnadc_jan2020_rep</span> <span class="op">&lt;-</span> <span class="va">pnadc_monthly</span><span class="op">[</span><span class="va">ref_month_yyyymm</span> <span class="op">==</span> <span class="fl">202001</span> <span class="op">&amp;</span> <span class="va">V2009</span> <span class="op">&gt;=</span> <span class="fl">14</span><span class="op">]</span></span>
<span><span class="va">rep_weight_cols_monthly</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"V1028"</span>, <span class="fu"><a href="https://rdrr.io/r/base/sprintf.html" class="external-link">sprintf</a></span><span class="op">(</span><span class="st">"%03d"</span>, <span class="fl">1</span><span class="op">:</span><span class="fl">200</span><span class="op">)</span>, <span class="st">"_monthly"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">design_rep</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/survey/man/svrepdesign.html" class="external-link">svrepdesign</a></span><span class="op">(</span></span>
<span>  data <span class="op">=</span> <span class="va">pnadc_jan2020_rep</span>,</span>
<span>  weights <span class="op">=</span> <span class="op">~</span><span class="va">weight_monthly</span>,</span>
<span>  repweights <span class="op">=</span> <span class="va">rep_weight_cols_monthly</span>,</span>
<span>  type <span class="op">=</span> <span class="st">"bootstrap"</span>,</span>
<span>  combined.weights <span class="op">=</span> <span class="cn">TRUE</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Use the same svymean/svyby functions as with linearization</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/survey/man/surveysummary.html" class="external-link">svymean</a></span><span class="op">(</span><span class="op">~</span><span class="fu"><a href="https://rdrr.io/r/base/AsIs.html" class="external-link">I</a></span><span class="op">(</span><span class="va">VD4001</span> <span class="op">==</span> <span class="fl">1</span><span class="op">)</span>, <span class="va">design_rep</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code></pre></div>
<div class="section level3">
<h3 id="comparing-strategies">Comparing Strategies<a class="anchor" aria-label="anchor" href="#comparing-strategies"></a>
</h3>
<table class="table">
<colgroup>
<col width="22%">
<col width="40%">
<col width="37%">
</colgroup>
<thead><tr class="header">
<th>Aspect</th>
<th>Linearization</th>
<th>Replication</th>
</tr></thead>
<tbody>
<tr class="odd">
<td><strong>Setup</strong></td>
<td>Simpler (strata + PSU)</td>
<td>More complex (200 weight columns)</td>
</tr>
<tr class="even">
<td><strong>Speed</strong></td>
<td>Fast</td>
<td>Slower (200x calculations)</td>
</tr>
<tr class="odd">
<td><strong>Complex statistics</strong></td>
<td>May need special formulas</td>
<td>Handles automatically</td>
</tr>
<tr class="even">
<td><strong>Best for</strong></td>
<td>Routine analysis</td>
<td>Quantiles, Gini, publications</td>
</tr>
</tbody>
</table>
<p><strong>Recommendation</strong>: Use linearization for exploratory
analysis and most routine work. Use replication when computing complex
statistics or preparing results for publication.</p>
<hr>
</div>
</div>
<div class="section level2">
<h2 id="practical-example-gender-gap-in-labor-force-participation">Practical Example: Gender Gap in Labor Force Participation<a class="anchor" aria-label="anchor" href="#practical-example-gender-gap-in-labor-force-participation"></a>
</h2>
<p>Brazil has one of the largest gender gaps in labor force
participation among major economies—about 20 percentage points. COVID-19
provides a natural experiment: school closures and increased caregiving
demands fell disproportionately on women. Monthly data lets us track
whether the gap widened, and confidence intervals tell us if the change
was statistically significant.</p>
<div class="section level3">
<h3 id="computing-the-gender-gap">Computing the Gender Gap<a class="anchor" aria-label="anchor" href="#computing-the-gender-gap"></a>
</h3>
<p>The gap is a derived statistic: the difference between two survey
estimates. We derive it from the by-sex results already computed
above:</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Reshape to wide format to compute gap</span></span>
<span><span class="va">results_wide</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/data.table/man/dcast.data.table.html" class="external-link">dcast</a></span><span class="op">(</span><span class="va">results_by_sex</span>, <span class="va">ref_month_yyyymm</span> <span class="op">+</span> <span class="va">period</span> <span class="op">~</span> <span class="va">sex</span>,</span>
<span>                      value.var <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"participation"</span>, <span class="st">"se"</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Compute gap and its SE</span></span>
<span><span class="co"># SE of difference: SE(gap) = sqrt(SE_men^2 + SE_women^2)</span></span>
<span><span class="va">results_wide</span><span class="op">[</span>, <span class="fu">`:=`</span><span class="op">(</span></span>
<span>  gap <span class="op">=</span> <span class="va">participation_Men</span> <span class="op">-</span> <span class="va">participation_Women</span>,</span>
<span>  gap_se <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">sqrt</a></span><span class="op">(</span><span class="va">se_Men</span><span class="op">^</span><span class="fl">2</span> <span class="op">+</span> <span class="va">se_Women</span><span class="op">^</span><span class="fl">2</span><span class="op">)</span></span>
<span><span class="op">)</span><span class="op">]</span></span>
<span></span>
<span><span class="va">results_wide</span><span class="op">[</span>, <span class="fu">`:=`</span><span class="op">(</span></span>
<span>  gap_ci_lower <span class="op">=</span> <span class="va">gap</span> <span class="op">-</span> <span class="fl">1.96</span> <span class="op">*</span> <span class="va">gap_se</span>,</span>
<span>  gap_ci_upper <span class="op">=</span> <span class="va">gap</span> <span class="op">+</span> <span class="fl">1.96</span> <span class="op">*</span> <span class="va">gap_se</span></span>
<span><span class="op">)</span><span class="op">]</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="visualizing-the-results">Visualizing the Results<a class="anchor" aria-label="anchor" href="#visualizing-the-results"></a>
</h3>
<details><summary>
Show plotting code
</summary><div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Reshape back to long for plotting</span></span>
<span><span class="va">results_long</span> <span class="op">&lt;-</span> <span class="va">results_by_sex</span><span class="op">[</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">participation</span><span class="op">)</span><span class="op">]</span></span>
<span></span>
<span><span class="co"># Ensure proper CI columns exist</span></span>
<span><span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="st">"ci_l"</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">results_long</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">results_long</span><span class="op">[</span>, <span class="va">ci_l</span> <span class="op">:=</span> <span class="va">participation</span> <span class="op">-</span> <span class="fl">1.96</span> <span class="op">*</span> <span class="va">se</span><span class="op">]</span></span>
<span>  <span class="va">results_long</span><span class="op">[</span>, <span class="va">ci_u</span> <span class="op">:=</span> <span class="va">participation</span> <span class="op">+</span> <span class="fl">1.96</span> <span class="op">*</span> <span class="va">se</span><span class="op">]</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">p1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">results_long</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">period</span>, y <span class="op">=</span> <span class="va">participation</span>, color <span class="op">=</span> <span class="va">sex</span>, fill <span class="op">=</span> <span class="va">sex</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span></span>
<span>  <span class="co"># Confidence bands</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_ribbon.html" class="external-link">geom_ribbon</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>ymin <span class="op">=</span> <span class="va">ci_l</span>, ymax <span class="op">=</span> <span class="va">ci_u</span><span class="op">)</span>, alpha <span class="op">=</span> <span class="fl">0.2</span>, color <span class="op">=</span> <span class="cn">NA</span><span class="op">)</span> <span class="op">+</span></span>
<span></span>
<span>  <span class="co"># Point estimates</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span>linewidth <span class="op">=</span> <span class="fl">0.8</span><span class="op">)</span> <span class="op">+</span></span>
<span></span>
<span>  <span class="co"># Highlight COVID period</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/annotate.html" class="external-link">annotate</a></span><span class="op">(</span><span class="st">"rect"</span>,</span>
<span>           xmin <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/as.Date.html" class="external-link">as.Date</a></span><span class="op">(</span><span class="st">"2020-03-01"</span><span class="op">)</span>, xmax <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/as.Date.html" class="external-link">as.Date</a></span><span class="op">(</span><span class="st">"2021-12-31"</span><span class="op">)</span>,</span>
<span>           ymin <span class="op">=</span> <span class="op">-</span><span class="cn">Inf</span>, ymax <span class="op">=</span> <span class="cn">Inf</span>,</span>
<span>           fill <span class="op">=</span> <span class="st">"gray80"</span>, alpha <span class="op">=</span> <span class="fl">0.3</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/annotate.html" class="external-link">annotate</a></span><span class="op">(</span><span class="st">"text"</span>,</span>
<span>           x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/as.Date.html" class="external-link">as.Date</a></span><span class="op">(</span><span class="st">"2021-01-01"</span><span class="op">)</span>, y <span class="op">=</span> <span class="fl">0.85</span>,</span>
<span>           label <span class="op">=</span> <span class="st">"COVID-19"</span>, fontface <span class="op">=</span> <span class="st">"italic"</span>, size <span class="op">=</span> <span class="fl">3</span>, color <span class="op">=</span> <span class="st">"gray40"</span><span class="op">)</span> <span class="op">+</span></span>
<span></span>
<span>  <span class="co"># Scales and labels</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html" class="external-link">scale_y_continuous</a></span><span class="op">(</span></span>
<span>    labels <span class="op">=</span> <span class="fu"><a href="https://scales.r-lib.org/reference/percent_format.html" class="external-link">percent_format</a></span><span class="op">(</span>accuracy <span class="op">=</span> <span class="fl">1</span><span class="op">)</span>,</span>
<span>    limits <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.45</span>, <span class="fl">0.85</span><span class="op">)</span>,</span>
<span>    breaks <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">0.45</span>, <span class="fl">0.85</span>, <span class="fl">0.05</span><span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_date.html" class="external-link">scale_x_date</a></span><span class="op">(</span>date_breaks <span class="op">=</span> <span class="st">"1 year"</span>, date_labels <span class="op">=</span> <span class="st">"%Y"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_manual.html" class="external-link">scale_color_manual</a></span><span class="op">(</span>values <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Men"</span> <span class="op">=</span> <span class="st">"#0074D9"</span>, <span class="st">"Women"</span> <span class="op">=</span> <span class="st">"#FF4136"</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_manual.html" class="external-link">scale_fill_manual</a></span><span class="op">(</span>values <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Men"</span> <span class="op">=</span> <span class="st">"#0074D9"</span>, <span class="st">"Women"</span> <span class="op">=</span> <span class="st">"#FF4136"</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span></span>
<span>    title <span class="op">=</span> <span class="st">"Labor Force Participation by Sex: Monthly Series with 95% Confidence Intervals"</span>,</span>
<span>    subtitle <span class="op">=</span> <span class="st">"Brazil, 2012-2025. Shaded regions show 95% confidence bands from complex survey design."</span>,</span>
<span>    x <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>    y <span class="op">=</span> <span class="st">"Labor Force Participation Rate"</span>,</span>
<span>    color <span class="op">=</span> <span class="st">"Sex"</span>,</span>
<span>    fill <span class="op">=</span> <span class="st">"Sex"</span>,</span>
<span>    caption <span class="op">=</span> <span class="st">"Source: PNADC/IBGE. Monthly weights from PNADCperiods. Variance estimated via Taylor linearization."</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_minimal</a></span><span class="op">(</span>base_size <span class="op">=</span> <span class="fl">11</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span></span>
<span>    plot.title <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_text</a></span><span class="op">(</span>face <span class="op">=</span> <span class="st">"bold"</span><span class="op">)</span>,</span>
<span>    legend.position <span class="op">=</span> <span class="st">"bottom"</span>,</span>
<span>    panel.grid.minor <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_blank</a></span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span><span class="va">p1</span></span></code></pre></div>
</details><div class="float">
<img src="figures/complex-survey-design/fig-gender-participation-ci.png" style="width:100.0%" alt="Labor Force Participation by Sex with 95% Confidence Intervals"><div class="figcaption">Labor Force Participation by Sex with 95%
Confidence Intervals</div>
</div>
<p>The confidence bands for men and women never overlap, confirming that
the gender gap is statistically significant in every month. Women’s
participation dropped more sharply during COVID-19 (from ~53% to below
47%) than men’s (from ~73% to ~66%).</p>
<details><summary>
Show plotting code
</summary><div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Pre-COVID average for reference line</span></span>
<span><span class="va">pre_covid_avg</span> <span class="op">&lt;-</span> <span class="va">results_wide</span><span class="op">[</span><span class="va">period</span> <span class="op">&lt;</span> <span class="st">"2020-03-01"</span>, <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">gap</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">]</span></span>
<span></span>
<span><span class="va">p2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">results_wide</span><span class="op">[</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">gap</span><span class="op">)</span><span class="op">]</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">period</span>, y <span class="op">=</span> <span class="va">gap</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span></span>
<span>  <span class="co"># Confidence band</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_ribbon.html" class="external-link">geom_ribbon</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>ymin <span class="op">=</span> <span class="va">gap_ci_lower</span>, ymax <span class="op">=</span> <span class="va">gap_ci_upper</span><span class="op">)</span>,</span>
<span>              fill <span class="op">=</span> <span class="st">"#7b3294"</span>, alpha <span class="op">=</span> <span class="fl">0.3</span><span class="op">)</span> <span class="op">+</span></span>
<span></span>
<span>  <span class="co"># Point estimate</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span>color <span class="op">=</span> <span class="st">"#7b3294"</span>, linewidth <span class="op">=</span> <span class="fl">0.9</span><span class="op">)</span> <span class="op">+</span></span>
<span></span>
<span>  <span class="co"># Reference line at pre-COVID average</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html" class="external-link">geom_hline</a></span><span class="op">(</span></span>
<span>    yintercept <span class="op">=</span> <span class="va">pre_covid_avg</span>,</span>
<span>    linetype <span class="op">=</span> <span class="st">"dashed"</span>, color <span class="op">=</span> <span class="st">"gray50"</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/annotate.html" class="external-link">annotate</a></span><span class="op">(</span><span class="st">"text"</span>, x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">min</a></span><span class="op">(</span><span class="va">results_wide</span><span class="op">$</span><span class="va">period</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op">+</span> <span class="fl">180</span>,</span>
<span>           y <span class="op">=</span> <span class="va">pre_covid_avg</span> <span class="op">+</span> <span class="fl">0.008</span>,</span>
<span>           label <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"Pre-COVID avg: "</span>, <span class="fu"><a href="https://rdrr.io/r/base/sprintf.html" class="external-link">sprintf</a></span><span class="op">(</span><span class="st">"%.1f"</span>, <span class="va">pre_covid_avg</span> <span class="op">*</span> <span class="fl">100</span><span class="op">)</span>, <span class="st">" p.p."</span><span class="op">)</span>,</span>
<span>           size <span class="op">=</span> <span class="fl">3</span>, color <span class="op">=</span> <span class="st">"gray40"</span>, hjust <span class="op">=</span> <span class="fl">0</span><span class="op">)</span> <span class="op">+</span></span>
<span></span>
<span>  <span class="co"># Highlight COVID period</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/annotate.html" class="external-link">annotate</a></span><span class="op">(</span><span class="st">"rect"</span>,</span>
<span>           xmin <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/as.Date.html" class="external-link">as.Date</a></span><span class="op">(</span><span class="st">"2020-03-01"</span><span class="op">)</span>, xmax <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/as.Date.html" class="external-link">as.Date</a></span><span class="op">(</span><span class="st">"2021-12-31"</span><span class="op">)</span>,</span>
<span>           ymin <span class="op">=</span> <span class="op">-</span><span class="cn">Inf</span>, ymax <span class="op">=</span> <span class="cn">Inf</span>,</span>
<span>           fill <span class="op">=</span> <span class="st">"gray80"</span>, alpha <span class="op">=</span> <span class="fl">0.3</span><span class="op">)</span> <span class="op">+</span></span>
<span></span>
<span>  <span class="co"># Scales and labels</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html" class="external-link">scale_y_continuous</a></span><span class="op">(</span></span>
<span>    labels <span class="op">=</span> <span class="fu"><a href="https://scales.r-lib.org/reference/percent_format.html" class="external-link">percent_format</a></span><span class="op">(</span>accuracy <span class="op">=</span> <span class="fl">1</span><span class="op">)</span>,</span>
<span>    breaks <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">0.15</span>, <span class="fl">0.30</span>, <span class="fl">0.025</span><span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_date.html" class="external-link">scale_x_date</a></span><span class="op">(</span>date_breaks <span class="op">=</span> <span class="st">"1 year"</span>, date_labels <span class="op">=</span> <span class="st">"%Y"</span><span class="op">)</span> <span class="op">+</span></span>
<span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span></span>
<span>    title <span class="op">=</span> <span class="st">"Gender Gap in Labor Force Participation (Men - Women)"</span>,</span>
<span>    subtitle <span class="op">=</span> <span class="st">"Monthly series with 95% CI. Dashed line = pre-COVID average. Gap widened during pandemic."</span>,</span>
<span>    x <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>    y <span class="op">=</span> <span class="st">"Participation Gap (percentage points)"</span>,</span>
<span>    caption <span class="op">=</span> <span class="st">"Source: PNADC/IBGE. Monthly weights from PNADCperiods."</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_minimal</a></span><span class="op">(</span>base_size <span class="op">=</span> <span class="fl">11</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span></span>
<span>    plot.title <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_text</a></span><span class="op">(</span>face <span class="op">=</span> <span class="st">"bold"</span><span class="op">)</span>,</span>
<span>    panel.grid.minor <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_blank</a></span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span><span class="va">p2</span></span></code></pre></div>
</details><div class="float">
<img src="figures/complex-survey-design/fig-gender-gap-difference.png" style="width:100.0%" alt="Gender Gap in Labor Force Participation"><div class="figcaption">Gender Gap in Labor Force Participation</div>
</div>
<p>The gap widened from ~20 to ~23 percentage points during COVID-19,
and the confidence bands confirm this increase was statistically
significant. The gap returned to pre-pandemic levels by 2022.</p>
<hr>
</div>
</div>
<div class="section level2">
<h2 id="practical-tips">Practical Tips<a class="anchor" aria-label="anchor" href="#practical-tips"></a>
</h2>
<div class="section level3">
<h3 id="singleton-strata">Singleton Strata<a class="anchor" aria-label="anchor" href="#singleton-strata"></a>
</h3>
<p>Some months may have strata with only one PSU. The
<code>options(survey.lonely.psu = "adjust")</code> setting (shown in the
data preparation section above) provides a conservative adjustment.
Other options include <code>"remove"</code> and
<code>"average"</code>.</p>
</div>
<div class="section level3">
<h3 id="subpopulation-analysis">Subpopulation Analysis<a class="anchor" aria-label="anchor" href="#subpopulation-analysis"></a>
</h3>
<p>When analyzing subgroups, <strong>always subset the design
object</strong>, not the raw data:</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># CORRECT: Subset the design</span></span>
<span><span class="va">design_women</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/subset.html" class="external-link">subset</a></span><span class="op">(</span><span class="va">design_jan2020</span>, <span class="va">V2007</span> <span class="op">==</span> <span class="fl">2</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/survey/man/surveysummary.html" class="external-link">svymean</a></span><span class="op">(</span><span class="op">~</span><span class="fu"><a href="https://rdrr.io/r/base/AsIs.html" class="external-link">I</a></span><span class="op">(</span><span class="va">VD4001</span> <span class="op">==</span> <span class="fl">1</span><span class="op">)</span>, <span class="va">design_women</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># INCORRECT: Don't do this - loses design information</span></span>
<span><span class="co"># bad_design &lt;- svydesign(..., data = pnadc[V2007 == 2])</span></span></code></pre></div>
<p>Subsetting the data before creating the design object loses
information about the full sample structure, leading to incorrect
variance estimates.</p>
<hr>
</div>
</div>
<div class="section level2">
<h2 id="summary">Summary<a class="anchor" aria-label="anchor" href="#summary"></a>
</h2>
<p>This vignette demonstrated two approaches for computing standard
errors with monthly PNADC weights:</p>
<ol style="list-style-type: decimal">
<li>
<strong>Linearization</strong>: Use <code>Estrato</code> as strata,
<code>UPA</code> as PSU, and <code>weight_monthly</code> as weight in
<code><a href="https://rdrr.io/pkg/survey/man/svydesign.html" class="external-link">svydesign()</a></code>. Fast, simple, works for most statistics.</li>
<li>
<strong>Replication</strong>: Multiply each bootstrap weight by
<code>weight_monthly / V1028</code>. More intensive but exact for
complex statistics.</li>
</ol>
<p>The gender gap example demonstrated that confidence intervals
transform a claim like “the gap looks bigger” into “the gap increased by
2-3 percentage points, and we’re 95% confident it’s real.”</p>
<hr>
</div>
<div class="section level2">
<h2 id="further-reading">Further Reading<a class="anchor" aria-label="anchor" href="#further-reading"></a>
</h2>
<ul>
<li>
<a href="getting-started.html">Get Started</a> - Basic mensalization
workflow</li>
<li>
<a href="applied-examples.html">Applied Examples</a> - Monthly labor
market analysis with figures</li>
<li>Thomas Lumley (2010). <em>Complex Surveys: A Guide to Analysis Using
R</em>. Wiley.</li>
<li>IBGE. <em>Notas Metodologicas da PNAD Continua</em>.</li>
</ul>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by <a href="https://orcid.org/0000-0002-6796-4547" class="external-link">Rogerio Barbosa</a>, <a href="https://orcid.org/0000-0003-2992-1252" class="external-link">Marcos Hecksher</a>.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.3.</p>
</div>

    </footer>
</div>





  </body>
</html>
