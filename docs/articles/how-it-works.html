<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>How PNADCperiods Works • PNADCperiods</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="How PNADCperiods Works">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-primary" data-bs-theme="dark" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">PNADCperiods</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.1.0</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../articles/getting-started.html">Get Started</a></li>
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/download-and-prepare.html">Download and Prepare Data</a></li>
    <li><a class="dropdown-item" href="../articles/applied-examples.html">Applied Examples</a></li>
    <li><a class="dropdown-item" href="../articles/annual-poverty-analysis.html">Annual Poverty Analysis</a></li>
    <li><a class="dropdown-item" href="../articles/complex-survey-design.html">Complex Survey Design</a></li>
    <li><a class="dropdown-item" href="../articles/how-it-works.html">How PNADCperiods Works</a></li>
    <li><hr class="dropdown-divider"></li>
    <li><a class="dropdown-item" href="../articles/sidra-mensalization.html">SIDRA Mensalization Guide</a></li>
  </ul>
</li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/antrologos/PNADCperiods/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>How PNADCperiods Works</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/antrologos/PNADCperiods/blob/HEAD/vignettes/how-it-works.Rmd" class="external-link"><code>vignettes/how-it-works.Rmd</code></a></small>
      <div class="d-none name"><code>how-it-works.Rmd</code></div>
    </div>

    
    
<!--
MAINTAINER NOTE:
This vignette uses eval=FALSE for all code chunks.
Pre-computed figures are generated by:
  code/generate_how_it_works_figures.R

Figures are stored in: vignettes/figures/how-it-works/

To regenerate, run the generation script. The script caches intermediate
results in data/processed/ for faster subsequent runs.
-->
<div class="section level2">
<h2 id="introduction">Introduction<a class="anchor" aria-label="anchor" href="#introduction"></a>
</h2>
<p>This vignette explains <strong>how the PNADCperiods algorithm
works</strong>: the methodology behind converting Brazil’s quarterly
PNADC survey into sub-quarterly time series with calibrated weights. For
practical usage, see the <a href="getting-started.html">Get Started</a>
vignette.</p>
<p>Policy questions often require sub-quarterly precision that raw PNADC
data cannot provide:</p>
<ul>
<li>When exactly did unemployment spike during COVID-19? (March 2020
vs. January 2020)</li>
<li>How quickly did labor markets respond to minimum wage changes?
(month-to-month transitions)</li>
<li>What was poverty in December 2023 specifically? (not just Q4 2023
average)</li>
</ul>
<p>The algorithm exploits PNADC’s rotating panel design and birthday
information to recover this temporal precision. By identifying when each
household was actually interviewed within the quarter, we can construct
monthly time series with 97% of the original sample retained.</p>
<p><strong>What this vignette covers:</strong></p>
<ol style="list-style-type: decimal">
<li>Why stacked multi-quarter data improves determination from ~70% to
~97%</li>
<li>The core algorithm: valid interview dates, birthday constraints,
UPA-panel aggregation, cross-quarter propagation, dynamic exception
detection</li>
<li>Nested identification hierarchy (months &gt; fortnights &gt;
weeks)</li>
<li>Experimental strategies for improved fortnight/week
determination</li>
<li>Weight calibration and smoothing</li>
<li>Performance characteristics</li>
</ol>
<p><strong>Prerequisites:</strong> This vignette assumes familiarity
with basic PNADC concepts (UPA, rotation groups, survey weights) and
focuses on <strong>understanding the methodology</strong> rather than
how to use the functions. For applied examples, see the <a href="applied-examples.html">Applied Examples</a> vignette.</p>
<hr>
</div>
<div class="section level2">
<h2 id="why-stacked-data-matters">Why Stacked Data Matters<a class="anchor" aria-label="anchor" href="#why-stacked-data-matters"></a>
</h2>
<p>The algorithm achieves <strong>97% determination rate</strong> when
processing <strong>stacked multi-quarter data</strong> (full 55-quarter
history). If you process quarters individually, you’ll only get ~73%
determination.</p>
<p><strong>Why does stacking help?</strong> PNADC uses a
<strong>rotating panel</strong> where each household (UPA + V1014) is
interviewed for 5 consecutive quarters. Crucially, the same household is
always interviewed in the <strong>same relative month position</strong>
(always month 1, always month 2, or always month 3). This means birthday
constraints from <strong>any quarter</strong> can determine the month
for <strong>all quarters</strong>:</p>
<pre><code>UPA=123456, V1014=1 appears in 5 quarters:

  2023-Q1: month_min=1, month_max=2 (ambiguous: Jan or Feb)
  2023-Q2: month_min=1, month_max=3 (ambiguous: Apr, May, or Jun)
  2023-Q3: month_min=2, month_max=2 (DETERMINED: August)  &lt;- Birthday constraint!
  2023-Q4: month_min=1, month_max=2 (ambiguous: Oct or Nov)
  2024-Q1: month_min=2, month_max=3 (ambiguous: Feb or Mar)

Cross-quarter aggregation:
  upa_month_min = max(1, 1, 2, 1, 2) = 2
  upa_month_max = min(2, 3, 2, 2, 3) = 2

Result: ALL 5 quarters -&gt; ref_month_in_quarter = 2</code></pre>
<p><strong>Empirical determination rates by number of quarters
stacked</strong> (from real PNADC 2012-2025 data):</p>
<table class="table">
<thead><tr class="header">
<th>Quarters Stacked</th>
<th>Observations</th>
<th>Determination Rate</th>
</tr></thead>
<tbody>
<tr class="odd">
<td>1 (single quarter)</td>
<td>566,873</td>
<td>73.0%</td>
</tr>
<tr class="even">
<td>2</td>
<td>1,133,889</td>
<td>88.2%</td>
</tr>
<tr class="odd">
<td>4 (1 year)</td>
<td>2,252,464</td>
<td>93.9%</td>
</tr>
<tr class="even">
<td>8 (2 years)</td>
<td>4,530,641</td>
<td>96.3%</td>
</tr>
<tr class="odd">
<td>12 (3 years)</td>
<td>6,828,144</td>
<td>97.1%</td>
</tr>
<tr class="even">
<td>20 (5 years)</td>
<td>11,391,346</td>
<td>97.3%</td>
</tr>
<tr class="odd">
<td>32 (8 years)</td>
<td>18,088,581</td>
<td><strong>97.4%</strong></td>
</tr>
<tr class="even">
<td>55 (full history)</td>
<td>28,395,273</td>
<td>97.0%</td>
</tr>
</tbody>
</table>
<p>The rate peaks around 32 quarters then stabilizes, because the
boundary quarters (first 4 and last 4 of any series) have inherently
lower rates due to incomplete panel coverage.</p>
<details><summary><strong>Show plotting code</strong> (determination rate figure)
</summary><div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">p1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">cumulative_det</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">n_quarters</span>, y <span class="op">=</span> <span class="va">det_rate</span> <span class="op">*</span> <span class="fl">100</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span>color <span class="op">=</span> <span class="st">"#2166ac"</span>, linewidth <span class="op">=</span> <span class="fl">1.2</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span>color <span class="op">=</span> <span class="st">"#2166ac"</span>, size <span class="op">=</span> <span class="fl">3.5</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html" class="external-link">geom_hline</a></span><span class="op">(</span>yintercept <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">cumulative_det</span><span class="op">$</span><span class="va">det_rate</span><span class="op">)</span> <span class="op">*</span> <span class="fl">100</span>,</span>
<span>             linetype <span class="op">=</span> <span class="st">"dashed"</span>, color <span class="op">=</span> <span class="st">"#666666"</span>, alpha <span class="op">=</span> <span class="fl">0.7</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/annotate.html" class="external-link">annotate</a></span><span class="op">(</span><span class="st">"text"</span>,</span>
<span>           x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">cumulative_det</span><span class="op">$</span><span class="va">n_quarters</span><span class="op">)</span> <span class="op">*</span> <span class="fl">0.85</span>,</span>
<span>           y <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">cumulative_det</span><span class="op">$</span><span class="va">det_rate</span><span class="op">)</span> <span class="op">*</span> <span class="fl">100</span> <span class="op">+</span> <span class="fl">1.2</span>,</span>
<span>           label <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sprintf.html" class="external-link">sprintf</a></span><span class="op">(</span><span class="st">"%.1f%%"</span>, <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">cumulative_det</span><span class="op">$</span><span class="va">det_rate</span><span class="op">)</span> <span class="op">*</span> <span class="fl">100</span><span class="op">)</span>,</span>
<span>                         <span class="st">" (full history)"</span><span class="op">)</span>,</span>
<span>           color <span class="op">=</span> <span class="st">"#666666"</span>, size <span class="op">=</span> <span class="fl">3.5</span>, hjust <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/annotate.html" class="external-link">annotate</a></span><span class="op">(</span><span class="st">"text"</span>,</span>
<span>           x <span class="op">=</span> <span class="fl">2</span>,</span>
<span>           y <span class="op">=</span> <span class="va">cumulative_det</span><span class="op">[</span><span class="va">n_quarters</span> <span class="op">==</span> <span class="fl">1</span>, <span class="va">det_rate</span> <span class="op">*</span> <span class="fl">100</span><span class="op">]</span> <span class="op">+</span> <span class="fl">2</span>,</span>
<span>           label <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sprintf.html" class="external-link">sprintf</a></span><span class="op">(</span><span class="st">"%.0f%%"</span>, <span class="va">cumulative_det</span><span class="op">[</span><span class="va">n_quarters</span> <span class="op">==</span> <span class="fl">1</span>, <span class="va">det_rate</span> <span class="op">*</span> <span class="fl">100</span><span class="op">]</span><span class="op">)</span>,</span>
<span>                         <span class="st">"\n(single quarter)"</span><span class="op">)</span>,</span>
<span>           color <span class="op">=</span> <span class="st">"#2166ac"</span>, size <span class="op">=</span> <span class="fl">3</span>, hjust <span class="op">=</span> <span class="fl">0</span>, vjust <span class="op">=</span> <span class="fl">0</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html" class="external-link">scale_x_continuous</a></span><span class="op">(</span></span>
<span>    breaks <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">10</span>, <span class="fl">20</span>, <span class="fl">30</span>, <span class="fl">40</span>, <span class="fl">50</span><span class="op">)</span>,</span>
<span>    limits <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">cumulative_det</span><span class="op">$</span><span class="va">n_quarters</span><span class="op">)</span> <span class="op">+</span> <span class="fl">5</span><span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html" class="external-link">scale_y_continuous</a></span><span class="op">(</span></span>
<span>    breaks <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">65</span>, <span class="fl">100</span>, by <span class="op">=</span> <span class="fl">5</span><span class="op">)</span>,</span>
<span>    limits <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">60</span>, <span class="fl">100</span><span class="op">)</span>,</span>
<span>    labels <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">x</span>, <span class="st">"%"</span><span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span></span>
<span>    title <span class="op">=</span> <span class="st">"Monthly Determination Rate Improves with More Quarters Stacked"</span>,</span>
<span>    subtitle <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"Real PNADC data (2012-"</span>, <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">quarterly_det</span><span class="op">$</span><span class="va">Ano</span><span class="op">)</span>,</span>
<span>                      <span class="st">"): Cross-quarter aggregation exploits rotating panel design"</span><span class="op">)</span>,</span>
<span>    x <span class="op">=</span> <span class="st">"Number of Quarters Stacked"</span>,</span>
<span>    y <span class="op">=</span> <span class="st">"Determination Rate"</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_minimal</a></span><span class="op">(</span>base_size <span class="op">=</span> <span class="fl">12</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span></span>
<span>    plot.title <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_text</a></span><span class="op">(</span>face <span class="op">=</span> <span class="st">"bold"</span>, size <span class="op">=</span> <span class="fl">14</span><span class="op">)</span>,</span>
<span>    plot.subtitle <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_text</a></span><span class="op">(</span>color <span class="op">=</span> <span class="st">"#666666"</span>, size <span class="op">=</span> <span class="fl">11</span><span class="op">)</span>,</span>
<span>    panel.grid.minor <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_blank</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>    axis.title <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_text</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fl">11</span><span class="op">)</span>,</span>
<span>    plot.margin <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">margin</a></span><span class="op">(</span><span class="fl">10</span>, <span class="fl">20</span>, <span class="fl">10</span>, <span class="fl">10</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="va">p1</span></span></code></pre></div>
</details><div class="float">
<img src="figures/how-it-works/fig-determination-rate.png" style="width:100.0%" alt="Determination rate improves with more stacked quarters"><div class="figcaption">Determination rate improves with more stacked
quarters</div>
</div>
<p><strong>Recommended</strong>: Stack at least 2 years (8 quarters) of
data before calling <code><a href="../reference/pnadc_identify_periods.html">pnadc_identify_periods()</a></code> to achieve
&gt;96% determination.</p>
<hr>
</div>
<div class="section level2">
<h2 id="the-algorithm-explained">The Algorithm Explained<a class="anchor" aria-label="anchor" href="#the-algorithm-explained"></a>
</h2>
<p>The reference period identification follows a pipeline with shared
initial steps and period-specific aggregation:</p>
<pre><code>+-----------------------------------------------------------------------------+
|                    REFERENCE PERIOD IDENTIFICATION PIPELINE                  |
+-----------------------------------------------------------------------------+

INPUTS (per observation):
  Year (Ano), Quarter (Trimestre), Birthday (V2008/V20081/V20082), Age (V2009)
        |
        v
SHARED COMPUTATION (All Periods):
  Step 1: Calculate valid interview Saturdays (IBGE rules)
  Step 2: Apply birthday constraints to narrow date range
  Step 3: Convert dates to period positions (month/fortnight/week)
        |
        v
NESTED IDENTIFICATION (enforced by construction):

  PHASE 1: MONTHS
  |-- Aggregate at (UPA, V1014) level
  |-- CROSS-QUARTER aggregation across ALL quarters
  |-- Dynamic exception detection
  +-- Determination: ~97% (55Q)
                |
                v (only if month determined)
  PHASE 2: FORTNIGHTS
  |-- Aggregate at (Ano, Trimestre, UPA, V1008) level
  |-- NO cross-quarter aggregation
  +-- Determination: ~9% (strict)
                |
                v (only if fortnight determined)
  PHASE 3: WEEKS
  |-- Aggregate at (Ano, Trimestre, UPA, V1008) level
  |-- NO cross-quarter aggregation
  +-- Determination: ~3% (strict)

OUTPUT:
  ref_month_in_quarter (1-3), ref_month_yyyymm (YYYYMM)
  ref_fortnight_in_quarter (1-6), ref_fortnight_yyyyff (YYYYFF)
  ref_week_in_quarter (1-13), ref_week_yyyyww (YYYYWW)
  determined_month, determined_fortnight, determined_week (logical flags)</code></pre>
<p>The identification is <strong>nested by construction</strong> —
fortnights can only be identified if the month is already determined,
and weeks only if the fortnight is determined. <strong>Months benefit
from cross-quarter aggregation</strong>, while fortnights and weeks
cannot aggregate across quarters. This explains why monthly
determination (97%) far exceeds fortnights (9%) and weeks (3%).</p>
<hr>
<div class="section level3">
<h3 id="shared-computation-steps-1-3">Shared Computation (Steps 1-3)<a class="anchor" aria-label="anchor" href="#shared-computation-steps-1-3"></a>
</h3>
<p>The following three steps are computed once and shared across all
period types.</p>
<div class="section level4">
<h4 id="step-1-valid-interview-saturdays-ibge-rules">Step 1: Valid Interview Saturdays (IBGE Rules)<a class="anchor" aria-label="anchor" href="#step-1-valid-interview-saturdays-ibge-rules"></a>
</h4>
<p>IBGE defines that a reference week belongs to a month only if it has
at least <strong>4 days within that month</strong>. Since reference
weeks end on Saturdays, we examine the Saturdays of each month to
determine valid interview dates.</p>
<p><strong>How we calculate the first valid Saturday:</strong></p>
<pre><code>first_saturday_day = day of the first Saturday of the month
if first_saturday_day &gt;= 4:
    use this Saturday (it has enough days in the month)
else:
    use the second Saturday (first_saturday_day + 7)</code></pre>
<p><strong>Example for Q1 2023:</strong></p>
<pre><code>JANUARY 2023:
  Sun  Mon  Tue  Wed  Thu  Fri  SAT
   1    2    3    4    5    6   [7]  &lt;- First Saturday is day 7
                                     7 &gt;= 4? YES -&gt; Valid! (7 days in January)

FEBRUARY 2023:
  Wed  Thu  Fri  SAT  ...
   1    2    3   [4]              &lt;- First Saturday is day 4
                                  4 &gt;= 4? YES -&gt; Valid! (4 days in February)

APRIL 2023:
  SAT  Sun  Mon  Tue  ...
  [1]   2    3    4              &lt;- First Saturday is day 1
                                  1 &gt;= 4? NO -&gt; Skip to second Saturday!
  Fri  SAT  Sun  ...
   7   [8]   9                   &lt;- Use day 8 instead</code></pre>
<p>The valid Saturday calculation defines the <strong>possible interview
date range</strong> for the quarter: - <code>date_min</code> = First
valid Saturday of Month 1 - <code>date_max</code> = First valid Saturday
of Month 3 + 21 days</p>
<hr>
</div>
</div>
<div class="section level3">
<h3 id="step-2-birthday-constraints">Step 2: Birthday Constraints<a class="anchor" aria-label="anchor" href="#step-2-birthday-constraints"></a>
</h3>
<p>IBGE calculates age using the exact birthdate and the interview
reference date. By comparing the calculated age to the birth year, we
can determine whether the interview occurred before or after the
person’s birthday that year, narrowing the possible interview date
window.</p>
<pre><code>visit_before_birthday = (Survey_Year - Birth_Year) - Calculated_Age

If = 0: Interview was AFTER birthday (person already celebrated this year)
If = 1: Interview was BEFORE birthday (birthday hasn't happened yet)</code></pre>
<p><strong>Example: Interview AFTER birthday</strong></p>
<pre><code>Person: Born March 15, 1990
Survey Year and quarter: 2023 Q1
Calculated Age: 33

Check age: 2023 - 1990 = 33
           33 - 33 = 0  -&gt; Interview was AFTER March 15, 2023

New constraint:
  date_min = max(date_min, first_Saturday_on_or_after(March 15))
  date_min = max(Jan 7, March 18) = March 18

This person can only have been interviewed in MARCH (Month 3 of Q1).</code></pre>
<p><strong>Example: Interview BEFORE birthday</strong></p>
<pre><code>Person: Born February 17, 1990
Survey Year and quarter: 2023 Q1
Calculated Age: 32

Check age: 2023 - 1990 = 33
           33 - 32 = 1  -&gt; Interview was BEFORE February 17, 2023

Constraint: date_max = min(date_max, Saturday_before(birthday))
            date_max = min(March 25, February 11) = February 11

This person can only have been interviewed in JANUARY or early FEBRUARY.</code></pre>
<p><strong>Unknown birthdays</strong>: When V2008=99, V20081=99, or
V20082=9999, that person’s birthday cannot constrain the date. However,
they may still be determined through UPA-Panel aggregation (Step 4) or
cross-quarter aggregation (Step 5).</p>
<hr>
</div>
<div class="section level3">
<h3 id="step-3-date-to-period-position">Step 3: Date to Period Position<a class="anchor" aria-label="anchor" href="#step-3-date-to-period-position"></a>
</h3>
<p>Transform the date window [date_min, date_max] into period
positions:</p>
<p><strong>Month positions (1, 2, or 3):</strong></p>
<pre><code>For date_min: if day &lt;= 3 AND not in first month of quarter:
              subtract 1 from month position

For date_max: if day &lt;= 3:
              use the month of (date - 3 days) instead</code></pre>
<p><strong>Boundary handling</strong>: Interviews on days 1-3 of a month
typically belong to a reference week that started in the previous
month.</p>
<p><strong>Fortnight positions (1-6):</strong></p>
<pre><code>fortnight_pos = (month_pos - 1) * 2 + half_of_month
  where half_of_month = 1 if day &lt;= 15, else 2</code></pre>
<table class="table">
<thead><tr class="header">
<th>Month</th>
<th>Days 1-15</th>
<th>Days 16-31</th>
</tr></thead>
<tbody>
<tr class="odd">
<td>1</td>
<td>Fortnight 1</td>
<td>Fortnight 2</td>
</tr>
<tr class="even">
<td>2</td>
<td>Fortnight 3</td>
<td>Fortnight 4</td>
</tr>
<tr class="odd">
<td>3</td>
<td>Fortnight 5</td>
<td>Fortnight 6</td>
</tr>
</tbody>
</table>
<p><strong>Week positions (IBGE calendar):</strong></p>
<p>Weeks follow the IBGE calendar convention where weeks run
<strong>Sunday to Saturday</strong>. The first week of a month must have
at least 4 days in that month. Reference months contain either 4 or 5
complete weeks.</p>
<hr>
</div>
<div class="section level3">
<h3 id="month-identification-pipeline-steps-4-7">Month Identification Pipeline (Steps 4-7)<a class="anchor" aria-label="anchor" href="#month-identification-pipeline-steps-4-7"></a>
</h3>
<p>The month identification pipeline uses cross-quarter aggregation to
achieve ~97% determination.</p>
<div class="section level4">
<h4 id="step-4-upa-panel-aggregation">Step 4: UPA-Panel Aggregation<a class="anchor" aria-label="anchor" href="#step-4-upa-panel-aggregation"></a>
</h4>
<p>All people in the same <strong>UPA + V1014</strong> are interviewed
together in the <strong>same reference month</strong>. Take the
intersection:</p>
<pre><code>upa_month_min = MAX of all individual month_min_pos
upa_month_max = MIN of all individual month_max_pos</code></pre>
<p><strong>Example:</strong></p>
<pre><code>UPA=123456, Panel V1014=1 has 3 members:

Person A: month_min=1, month_max=2 (could be Jan or Feb)
Person B: month_min=1, month_max=3 (could be Jan, Feb, or Mar)
Person C: month_min=2, month_max=3 (could be Feb or Mar)

Aggregation:
  upa_month_min = max(1, 1, 2) = 2
  upa_month_max = min(2, 3, 3) = 2

Result: min=2, max=2 -&gt; Reference month is FEBRUARY!

Visual:
              Jan    Feb    Mar
Person A:     [=========]
Person B:     [============]
Person C:            [========]
Intersection:        [==]      &lt;- Only February satisfies all</code></pre>
</div>
<div class="section level4">
<h4 id="step-5-cross-quarter-aggregation">Step 5: Cross-Quarter Aggregation<a class="anchor" aria-label="anchor" href="#step-5-cross-quarter-aggregation"></a>
</h4>
<p>Since the relative month position is constant across quarters,
constraints from <strong>any</strong> quarter apply to
<strong>all</strong> quarters:</p>
<pre><code>For each (UPA, V1014) group across ALL quarters:
  upa_month_min = MAX of all month_min_pos from all quarters
  upa_month_max = MIN of all month_max_pos from all quarters</code></pre>
<p>This is why processing stacked data improves determination from ~70%
(single quarter) to 97% (full history). <strong>This cross-quarter
aggregation cannot be applied to fortnights or weeks</strong> — even
though a household is always in the same relative month, the specific
fortnight or week within that month varies by quarter.</p>
</div>
<div class="section level4">
<h4 id="step-6-dynamic-exception-detection">Step 6: Dynamic Exception Detection<a class="anchor" aria-label="anchor" href="#step-6-dynamic-exception-detection"></a>
</h4>
<p>In some quarters, the standard rule (first reference week with at
least 4 days) may produce impossible results
(<code>upa_month_min &gt; upa_month_max</code>). The algorithm detects
these and applies an <strong>alternative rule</strong> (at least 3 days
instead of 4):</p>
<pre><code>For each UPA-V1014:
  1. Calculate positions using STANDARD rules (&gt;= 4 days)
  2. Also calculate using ALTERNATIVE rules (&gt;= 3 days)
  3. If standard is impossible but alternative works:
     -&gt; Flag which month needs the exception
  4. Propagate: if ANY UPA in the quarter needs exception for a month,
     apply to ALL observations in that quarter</code></pre>
<p>Exception quarters are detected automatically. Examples found in
2012-2025 data: 2016q3, 2016q4, 2017q2, 2022q3, 2023q2, 2024q1.</p>
</div>
<div class="section level4">
<h4 id="step-7-final-assignment">Step 7: Final Assignment<a class="anchor" aria-label="anchor" href="#step-7-final-assignment"></a>
</h4>
<p>After applying exceptions: if
<code>upa_month_min == upa_month_max</code>, the reference month is
determined. Otherwise, it remains NA.</p>
<p><strong>What makes observations indeterminate (~3%)?</strong></p>
<ul>
<li>
<strong>Incomplete panel coverage</strong>: Boundary quarters
(first/last 4 of any series) have UPAs with fewer than 5 visits</li>
<li>
<strong>Unit non-response</strong>: Fewer responding households
means fewer birthday constraints</li>
<li>
<strong>Small household sizes or missing birth dates</strong>: Fewer
constraints to narrow down the month</li>
</ul>
<p>Indeterminate observations get <code>weight_monthly = NA</code> in
the output (with <code>keep_all = TRUE</code>).</p>
<hr>
</div>
</div>
<div class="section level3">
<h3 id="fortnight-and-week-identification">Fortnight and Week Identification<a class="anchor" aria-label="anchor" href="#fortnight-and-week-identification"></a>
</h3>
<p>Fortnights and weeks use the same shared computation (Steps 1-3) as
months, but with critical differences:</p>
<p><strong>1. They cannot aggregate across quarters.</strong> A
household’s relative month position is constant (always month 2), but
the specific fortnight or week varies by quarter. Therefore constraints
are evaluated <strong>within each quarter independently</strong>.</p>
<p><strong>2. Aggregation key differs.</strong> Fortnights and weeks
aggregate at <code>(Ano, Trimestre, UPA, V1008)</code> — household level
within quarter — rather than <code>(UPA, V1014)</code> across
quarters.</p>
<p><strong>3. Nesting is enforced.</strong> A fortnight can only be
determined if the month is already determined. A week can only be
determined if the fortnight is already determined.</p>
<p><strong>Fortnight algorithm:</strong></p>
<p>Fortnights divide the quarter into 6 periods (2 per month). For each
<code>(Ano, Trimestre, UPA, V1008)</code> group, aggregate fortnight
positions. If <code>min == max</code>, the fortnight is determined.</p>
<p><strong>Week algorithm:</strong></p>
<p>Weeks divide the quarter into approximately 13 periods (following the
IBGE Sunday-Saturday calendar). Same aggregation logic as fortnights.
Determination requires the fortnight to already be known.</p>
<table class="table">
<thead><tr class="header">
<th>Period</th>
<th>Strict Rate</th>
<th>Aggregation Scope</th>
</tr></thead>
<tbody>
<tr class="odd">
<td><strong>Month</strong></td>
<td>94-97%</td>
<td>Cross-quarter (UPA, V1014)</td>
</tr>
<tr class="even">
<td><strong>Fortnight</strong></td>
<td>~9%</td>
<td>Within-quarter (Ano, Trimestre, UPA, V1008)</td>
</tr>
<tr class="odd">
<td><strong>Week</strong></td>
<td>~3%</td>
<td>Within-quarter (Ano, Trimestre, UPA, V1008)</td>
</tr>
</tbody>
</table>
<hr>
</div>
</div>
<div class="section level2">
<h2 id="experimental-strategies">Experimental Strategies<a class="anchor" aria-label="anchor" href="#experimental-strategies"></a>
</h2>
<p>For applications requiring larger sub-monthly samples, the package
provides <strong>experimental strategies</strong> via
<code><a href="../reference/pnadc_experimental_periods.html">pnadc_experimental_periods()</a></code> that can moderately increase
fortnight and week determination rates.</p>
<blockquote>
<p><strong>Important</strong>: Experimental strategies produce “likely”
assignments based on additional assumptions. They are intended for
sensitivity analysis and robustness checks, not for replacing strict
determination in rigorous analysis.</p>
</blockquote>
<table class="table">
<colgroup>
<col width="22%">
<col width="36%">
<col width="25%">
<col width="15%">
</colgroup>
<thead><tr class="header">
<th>Strategy</th>
<th>Fortnight Rate</th>
<th>Week Rate</th>
<th>Notes</th>
</tr></thead>
<tbody>
<tr class="odd">
<td>Strict (default)</td>
<td>8.9%</td>
<td>3.3%</td>
<td>Definitive determinations only</td>
</tr>
<tr class="even">
<td>+ Probabilistic (conf=0.9)</td>
<td><strong>13.5%</strong></td>
<td>3.6%</td>
<td>Conservative probabilistic</td>
</tr>
<tr class="odd">
<td>+ Probabilistic (conf=0.8)</td>
<td>13.5%</td>
<td><strong>7.5%</strong></td>
<td>Maximum week coverage</td>
</tr>
<tr class="even">
<td>+ UPA Aggregation</td>
<td>8.9%</td>
<td>3.3%</td>
<td>No practical improvement</td>
</tr>
<tr class="odd">
<td>+ Both (conf=0.9)</td>
<td>13.5%</td>
<td>3.6%</td>
<td>Same as probabilistic alone</td>
</tr>
</tbody>
</table>
<p><strong>Key finding:</strong> Probabilistic strategy provides all the
improvement. UPA aggregation adds essentially nothing. Choose conf=0.9
for conservative analysis, conf=0.8 for maximum week coverage.</p>
<details><summary><strong>Show plotting code</strong> (experimental strategies figure)
</summary><div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Select key configurations for visualization</span></span>
<span><span class="va">exp_plot_data</span> <span class="op">&lt;-</span> <span class="va">experimental_rates</span><span class="op">[</span><span class="va">crosswalk_id</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span></span>
<span>  <span class="st">"CW-FULL"</span>, <span class="st">"EXP-P08"</span>, <span class="st">"EXP-P09"</span></span>
<span><span class="op">)</span><span class="op">]</span></span>
<span></span>
<span><span class="va">exp_plot_data</span><span class="op">[</span>, <span class="va">strategy_display</span> <span class="op">:=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="va">strategy_label</span>,</span>
<span>  levels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Strict baseline"</span>,</span>
<span>             <span class="st">"Probabilistic (conf=0.8)"</span>,</span>
<span>             <span class="st">"Probabilistic (conf=0.9)"</span><span class="op">)</span>,</span>
<span>  labels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Strict baseline"</span>,</span>
<span>             <span class="st">"Probabilistic (conf=0.8)"</span>,</span>
<span>             <span class="st">"Probabilistic (conf=0.9)"</span><span class="op">)</span></span>
<span><span class="op">)</span><span class="op">]</span></span>
<span></span>
<span><span class="co"># Reshape to long format</span></span>
<span><span class="va">exp_plot_data_long</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/data.table/man/melt.data.table.html" class="external-link">melt</a></span><span class="op">(</span><span class="va">exp_plot_data</span>,</span>
<span>  id.vars <span class="op">=</span> <span class="st">"strategy_display"</span>,</span>
<span>  measure.vars <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"det_month_overall"</span>, <span class="st">"det_fortnight_overall"</span>, <span class="st">"det_week_overall"</span><span class="op">)</span>,</span>
<span>  variable.name <span class="op">=</span> <span class="st">"period"</span>,</span>
<span>  value.name <span class="op">=</span> <span class="st">"rate"</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">exp_plot_data_long</span><span class="op">[</span>, <span class="va">period</span> <span class="op">:=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="va">period</span>,</span>
<span>  levels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"det_month_overall"</span>, <span class="st">"det_fortnight_overall"</span>, <span class="st">"det_week_overall"</span><span class="op">)</span>,</span>
<span>  labels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Month"</span>, <span class="st">"Fortnight"</span>, <span class="st">"Week"</span><span class="op">)</span></span>
<span><span class="op">)</span><span class="op">]</span></span>
<span></span>
<span><span class="va">exp_plot_data_long</span><span class="op">[</span>, <span class="va">rate_pct</span> <span class="op">:=</span> <span class="va">rate</span> <span class="op">*</span> <span class="fl">100</span><span class="op">]</span></span>
<span></span>
<span><span class="co"># Create bar chart</span></span>
<span><span class="va">p_exp</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">exp_plot_data_long</span>,</span>
<span>                <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">period</span>, y <span class="op">=</span> <span class="va">rate_pct</span>, fill <span class="op">=</span> <span class="va">strategy_display</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_bar.html" class="external-link">geom_col</a></span><span class="op">(</span>position <span class="op">=</span> <span class="st">"dodge"</span>, width <span class="op">=</span> <span class="fl">0.7</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_text.html" class="external-link">geom_text</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>label <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sprintf.html" class="external-link">sprintf</a></span><span class="op">(</span><span class="st">"%.1f%%"</span>, <span class="va">rate_pct</span><span class="op">)</span><span class="op">)</span>,</span>
<span>            position <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/position_dodge.html" class="external-link">position_dodge</a></span><span class="op">(</span>width <span class="op">=</span> <span class="fl">0.7</span><span class="op">)</span>,</span>
<span>            vjust <span class="op">=</span> <span class="op">-</span><span class="fl">0.5</span>, size <span class="op">=</span> <span class="fl">3</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span></span>
<span>    title <span class="op">=</span> <span class="st">"Determination Rates: Strict vs Probabilistic Strategies"</span>,</span>
<span>    subtitle <span class="op">=</span> <span class="st">"8-quarter benchmark (2019-2020), 3.76M observations"</span>,</span>
<span>    x <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>    y <span class="op">=</span> <span class="st">"Determination Rate (%)"</span>,</span>
<span>    fill <span class="op">=</span> <span class="st">"Strategy"</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html" class="external-link">scale_y_continuous</a></span><span class="op">(</span></span>
<span>    limits <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">105</span><span class="op">)</span>,</span>
<span>    breaks <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">100</span>, by <span class="op">=</span> <span class="fl">20</span><span class="op">)</span>,</span>
<span>    labels <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">x</span>, <span class="st">"%"</span><span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_manual.html" class="external-link">scale_fill_manual</a></span><span class="op">(</span>values <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span></span>
<span>    <span class="st">"Strict baseline"</span> <span class="op">=</span> <span class="st">"#D55E00"</span>,</span>
<span>    <span class="st">"Probabilistic (conf=0.8)"</span> <span class="op">=</span> <span class="st">"#0072B2"</span>,</span>
<span>    <span class="st">"Probabilistic (conf=0.9)"</span> <span class="op">=</span> <span class="st">"#009E73"</span></span>
<span>  <span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_minimal</a></span><span class="op">(</span>base_size <span class="op">=</span> <span class="fl">12</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span></span>
<span>    plot.title <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_text</a></span><span class="op">(</span>face <span class="op">=</span> <span class="st">"bold"</span>, size <span class="op">=</span> <span class="fl">14</span><span class="op">)</span>,</span>
<span>    plot.subtitle <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_text</a></span><span class="op">(</span>color <span class="op">=</span> <span class="st">"#666666"</span>, size <span class="op">=</span> <span class="fl">11</span><span class="op">)</span>,</span>
<span>    legend.position <span class="op">=</span> <span class="st">"bottom"</span>,</span>
<span>    panel.grid.major.x <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_blank</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>    panel.grid.minor <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_blank</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>    axis.title <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_text</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fl">11</span><span class="op">)</span>,</span>
<span>    plot.margin <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">margin</a></span><span class="op">(</span><span class="fl">10</span>, <span class="fl">20</span>, <span class="fl">10</span>, <span class="fl">10</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="va">p_exp</span></span></code></pre></div>
</details><div class="float">
<img src="figures/how-it-works/fig-experimental-strategies.png" style="width:100.0%" alt="Experimental strategies: Probabilistic provides all gains"><div class="figcaption">Experimental strategies: Probabilistic provides
all gains</div>
</div>
<div class="section level3">
<h3 id="probabilistic-strategy">Probabilistic Strategy<a class="anchor" aria-label="anchor" href="#probabilistic-strategy"></a>
</h3>
<p>When the interview date range spans exactly <strong>2
fortnights</strong> or <strong>2 weeks</strong>, the probabilistic
strategy assigns the period containing the midpoint of the date
range.</p>
<pre><code>For each undetermined observation with date range [date_min, date_max]:
  1. Check if range spans exactly 2 periods
  2. Calculate the midpoint: date_midpoint = (date_min + date_max) / 2
  3. Assign the period containing the midpoint
  4. Calculate confidence: based on proportion of range in assigned period</code></pre>
<p><strong>Example:</strong></p>
<pre><code>Person with date range: March 10 - March 20 (within Q1 2023)
Fortnight boundary: March 15/16

Days in fortnight 5 (Mar 1-15):  10, 11, 12, 13, 14, 15 = 6 days
Days in fortnight 6 (Mar 16-31): 16, 17, 18, 19, 20     = 5 days

Date midpoint: March 15 -&gt; Falls in fortnight 5
Confidence: 6/11 ~ 0.55 (55% probability of fortnight 5)</code></pre>
<p>Most probabilistic assignments have relatively low confidence
(55-60%), meaning they’re only slightly better than a coin flip.
Consider filtering to higher confidence values (&gt;=0.7) for more
reliable analysis.</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Build standard crosswalk (store_date_bounds must be TRUE for experimental)</span></span>
<span><span class="va">crosswalk</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/pnadc_identify_periods.html">pnadc_identify_periods</a></span><span class="op">(</span><span class="va">pnadc_stacked</span>, store_date_bounds <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Apply probabilistic strategy with conservative threshold</span></span>
<span><span class="va">crosswalk_prob</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/pnadc_experimental_periods.html">pnadc_experimental_periods</a></span><span class="op">(</span></span>
<span>  <span class="va">crosswalk</span>,</span>
<span>  strategy <span class="op">=</span> <span class="st">"probabilistic"</span>,</span>
<span>  confidence_threshold <span class="op">=</span> <span class="fl">0.9</span>,</span>
<span>  verbose <span class="op">=</span> <span class="cn">TRUE</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Check results — experimental assigns determined_probable_* flags</span></span>
<span><span class="va">crosswalk_prob</span><span class="op">[</span>, <span class="fu">.</span><span class="op">(</span></span>
<span>  strict_fortnight <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">determined_fortnight</span><span class="op">)</span>,</span>
<span>  probable_fortnight <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">determined_probable_fortnight</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>  strict_week <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">determined_week</span><span class="op">)</span>,</span>
<span>  probable_week <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">determined_probable_week</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="op">)</span><span class="op">]</span></span>
<span></span>
<span><span class="co"># Filter to strictly determined only (excluding probabilistic)</span></span>
<span><span class="va">strict_only</span> <span class="op">&lt;-</span> <span class="va">crosswalk_prob</span><span class="op">[</span><span class="va">probabilistic_assignment</span> <span class="op">==</span> <span class="cn">FALSE</span><span class="op">]</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="upa-aggregation-strategy">UPA Aggregation Strategy<a class="anchor" aria-label="anchor" href="#upa-aggregation-strategy"></a>
</h3>
<p>The UPA aggregation strategy exploits a remarkable empirical finding:
<strong>100% UPA homogeneity</strong> for both fortnights and weeks
across 55 quarters of PNADC data (9.6 million household-quarter
observations). Whenever a fortnight or week IS strictly determined for
any household in a UPA, ALL strictly determined households in that UPA
have the SAME period.</p>
<p>Despite this finding, UPA aggregation provides essentially
<strong>zero improvement</strong> in comprehensive testing. Most UPAs
already have all households determined (or all undetermined) by the
strict algorithm. The strategy cannot create determinations where none
exist — it can only propagate existing ones within UPAs.</p>
<p><strong>Recommendation:</strong> Use
<code>strategy = "probabilistic"</code> for practical improvements. UPA
aggregation is available for methodological research via
<code>strategy = "upa_aggregation"</code> or
<code>strategy = "both"</code>.</p>
</div>
<div class="section level3">
<h3 id="output-columns">Output Columns<a class="anchor" aria-label="anchor" href="#output-columns"></a>
</h3>
<p><code><a href="../reference/pnadc_experimental_periods.html">pnadc_experimental_periods()</a></code> adds the following columns
to the crosswalk:</p>
<table class="table">
<colgroup>
<col width="29%">
<col width="22%">
<col width="48%">
</colgroup>
<thead><tr class="header">
<th>Column</th>
<th>Type</th>
<th>Description</th>
</tr></thead>
<tbody>
<tr class="odd">
<td><code>determined_probable_month</code></td>
<td>logical</td>
<td>TRUE if month was assigned by probabilistic strategy</td>
</tr>
<tr class="even">
<td><code>determined_probable_fortnight</code></td>
<td>logical</td>
<td>TRUE if fortnight was assigned by probabilistic strategy</td>
</tr>
<tr class="odd">
<td><code>determined_probable_week</code></td>
<td>logical</td>
<td>TRUE if week was assigned by probabilistic strategy</td>
</tr>
<tr class="even">
<td><code>probabilistic_assignment</code></td>
<td>logical</td>
<td>TRUE if any period was assigned experimentally (vs strict)</td>
</tr>
</tbody>
</table>
</div>
<div class="section level3">
<h3 id="caveats">Caveats<a class="anchor" aria-label="anchor" href="#caveats"></a>
</h3>
<ol style="list-style-type: decimal">
<li><p><strong>Low confidence assignments</strong>: Mean confidence is
~0.58. Many assignments are only marginally better than random. Consider
filtering to confidence &gt;= 0.7.</p></li>
<li><p><strong>Neither replaces strict determination</strong>: For
rigorous causal analysis or official statistics, strict determination
should be preferred.</p></li>
<li><p><strong>Use <code>probabilistic_assignment</code> flag</strong>:
Filter with <code>crosswalk[probabilistic_assignment == FALSE]</code> to
get strict-only assignments for sensitivity analysis.</p></li>
</ol>
<hr>
</div>
</div>
<div class="section level2">
<h2 id="weight-calibration">Weight Calibration<a class="anchor" aria-label="anchor" href="#weight-calibration"></a>
</h2>
<p>For sub-quarterly aggregate estimates, you need appropriately
calibrated survey weights. When <code>calibrate = TRUE</code> in
<code><a href="../reference/pnadc_apply_periods.html">pnadc_apply_periods()</a></code>, the package:</p>
<div class="section level3">
<h3 id="fetches-monthly-population-from-sidra-api">1. Fetches Monthly Population from SIDRA API<a class="anchor" aria-label="anchor" href="#fetches-monthly-population-from-sidra-api"></a>
</h3>
<p>SIDRA (table 6022) provides <strong>moving-quarter</strong>
population estimates (in thousands), not exact monthly values:</p>
<table class="table">
<thead><tr class="header">
<th>SIDRA Code</th>
<th>3-Month Window</th>
<th>Represents Population For</th>
</tr></thead>
<tbody>
<tr class="odd">
<td>201203</td>
<td>Jan+Feb+Mar 2012</td>
<td><strong>February 2012</strong></td>
</tr>
<tr class="even">
<td>201204</td>
<td>Feb+Mar+Apr 2012</td>
<td><strong>March 2012</strong></td>
</tr>
<tr class="odd">
<td>201205</td>
<td>Mar+Apr+May 2012</td>
<td><strong>April 2012</strong></td>
</tr>
</tbody>
</table>
<p>The package shifts values to align with their center month. Boundary
months (Jan 2012, latest month) are extrapolated via quadratic
regression.</p>
</div>
<div class="section level3">
<h3 id="applies-hierarchical-rake-weighting">2. Applies Hierarchical Rake Weighting<a class="anchor" aria-label="anchor" href="#applies-hierarchical-rake-weighting"></a>
</h3>
<p>Calibration cells are nested:</p>
<table class="table">
<colgroup>
<col width="36%">
<col width="36%">
<col width="27%">
</colgroup>
<thead><tr class="header">
<th>Cell Level</th>
<th>Definition</th>
<th>Purpose</th>
</tr></thead>
<tbody>
<tr class="odd">
<td><code>celula1</code></td>
<td>Age groups: 0-13, 14-29, 30-59, 60+</td>
<td>Demographic balance</td>
</tr>
<tr class="even">
<td><code>celula2</code></td>
<td>Post-stratum group + age</td>
<td>Regional-demographic balance</td>
</tr>
<tr class="odd">
<td><code>celula3</code></td>
<td>State (UF) + celula2</td>
<td>State-level balance</td>
</tr>
<tr class="even">
<td><code>celula4</code></td>
<td>Post-stratum (posest) + celula2</td>
<td>Fine geographic balance</td>
</tr>
</tbody>
</table>
<p>The number of cell levels depends on sample size at each
granularity:</p>
<table class="table">
<thead><tr class="header">
<th>Calibration Unit</th>
<th>Det. Rate</th>
<th>Cell Levels</th>
<th>Smoothing Window</th>
</tr></thead>
<tbody>
<tr class="odd">
<td>Month</td>
<td>94-97%</td>
<td>4 levels (celula1-4)</td>
<td>3-period rolling mean</td>
</tr>
<tr class="even">
<td>Fortnight</td>
<td>~9%</td>
<td>2 levels (celula1-2)</td>
<td>7-period rolling mean</td>
</tr>
<tr class="odd">
<td>Week</td>
<td>~3%</td>
<td>1 level (celula1 only)</td>
<td>No smoothing</td>
</tr>
</tbody>
</table>
</div>
<div class="section level3">
<h3 id="calibrates-to-monthly-population-totals">3. Calibrates to Monthly Population Totals<a class="anchor" aria-label="anchor" href="#calibrates-to-monthly-population-totals"></a>
</h3>
<p>Final scaling ensures monthly weighted totals match SIDRA population
(~206 million average).</p>
</div>
<div class="section level3">
<h3 id="weight-smoothing">Weight Smoothing<a class="anchor" aria-label="anchor" href="#weight-smoothing"></a>
</h3>
<p>The <code>smooth</code> parameter in
<code><a href="../reference/pnadc_apply_periods.html">pnadc_apply_periods()</a></code> (default: <code>FALSE</code>) applies
a rolling mean to cell-level calibration adjustments, reducing
artificial quarterly patterns in the weights.</p>
<p><strong>When to enable smoothing
(<code>smooth = TRUE</code>):</strong></p>
<ul>
<li>Computing time series for publication or visualization</li>
<li>Analyzing gradual trends (employment growth, demographic
shifts)</li>
</ul>
<p><strong>When to keep smoothing disabled (default):</strong></p>
<ul>
<li>Analyzing rapid shocks (COVID-19 lockdown, sudden policy
changes)</li>
<li>Studying immediate month-to-month changes</li>
<li>Comparing specific months across years</li>
</ul>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Monthly calibration (default)</span></span>
<span><span class="va">result</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/pnadc_apply_periods.html">pnadc_apply_periods</a></span><span class="op">(</span><span class="va">pnadc_stacked</span>, <span class="va">crosswalk</span>,</span>
<span>                               weight_var <span class="op">=</span> <span class="st">"V1028"</span>,</span>
<span>                               anchor <span class="op">=</span> <span class="st">"quarter"</span>,</span>
<span>                               calibrate <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># With smoothing for trend analysis</span></span>
<span><span class="va">result_smooth</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/pnadc_apply_periods.html">pnadc_apply_periods</a></span><span class="op">(</span><span class="va">pnadc_stacked</span>, <span class="va">crosswalk</span>,</span>
<span>                                      weight_var <span class="op">=</span> <span class="st">"V1028"</span>,</span>
<span>                                      anchor <span class="op">=</span> <span class="st">"quarter"</span>,</span>
<span>                                      smooth <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Fortnight calibration (simplified raking)</span></span>
<span><span class="va">result_fn</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/pnadc_apply_periods.html">pnadc_apply_periods</a></span><span class="op">(</span><span class="va">pnadc_stacked</span>, <span class="va">crosswalk</span>,</span>
<span>                                  weight_var <span class="op">=</span> <span class="st">"V1028"</span>,</span>
<span>                                  anchor <span class="op">=</span> <span class="st">"quarter"</span>,</span>
<span>                                  calibration_unit <span class="op">=</span> <span class="st">"fortnight"</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="handling-indeterminate-observations">Handling Indeterminate Observations<a class="anchor" aria-label="anchor" href="#handling-indeterminate-observations"></a>
</h3>
<p>By default (<code>keep_all = TRUE</code>), all input rows are
returned. Indeterminate observations get
<code>weight_monthly = NA</code>:</p>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># All rows returned (default keep_all = TRUE)</span></span>
<span><span class="va">result</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/pnadc_apply_periods.html">pnadc_apply_periods</a></span><span class="op">(</span><span class="va">pnadc_stacked</span>, <span class="va">crosswalk</span>,</span>
<span>                               weight_var <span class="op">=</span> <span class="st">"V1028"</span>,</span>
<span>                               anchor <span class="op">=</span> <span class="st">"quarter"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Filter to determined observations for analysis</span></span>
<span><span class="va">monthly_pop</span> <span class="op">&lt;-</span> <span class="va">result</span><span class="op">[</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">weight_monthly</span><span class="op">)</span>, <span class="fu">.</span><span class="op">(</span></span>
<span>  population <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">weight_monthly</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="op">)</span>, by <span class="op">=</span> <span class="va">ref_month_yyyymm</span><span class="op">]</span></span></code></pre></div>
<hr>
</div>
</div>
<div class="section level2">
<h2 id="performance">Performance<a class="anchor" aria-label="anchor" href="#performance"></a>
</h2>
<div class="section level3">
<h3 id="benchmarks">Benchmarks<a class="anchor" aria-label="anchor" href="#benchmarks"></a>
</h3>
<p><strong>Period Identification
(<code><a href="../reference/pnadc_identify_periods.html">pnadc_identify_periods()</a></code>):</strong></p>
<table class="table">
<thead><tr class="header">
<th>Dataset Size</th>
<th>Rows</th>
<th>Time</th>
<th>Throughput</th>
</tr></thead>
<tbody>
<tr class="odd">
<td>1 quarter</td>
<td>~570K</td>
<td>~1.5 sec</td>
<td>~380K rows/sec</td>
</tr>
<tr class="even">
<td>1 year</td>
<td>~2.3M</td>
<td>~5 sec</td>
<td>~460K rows/sec</td>
</tr>
<tr class="odd">
<td>14 years (2012-2025)</td>
<td>28.4M</td>
<td><strong>~2.5 minutes</strong></td>
<td>~177K rows/sec</td>
</tr>
</tbody>
</table>
<p><strong>Experimental Strategies
(<code><a href="../reference/pnadc_experimental_periods.html">pnadc_experimental_periods()</a></code>):</strong></p>
<table class="table">
<thead><tr class="header">
<th>Strategy</th>
<th>Time</th>
<th>Notes</th>
</tr></thead>
<tbody>
<tr class="odd">
<td>probabilistic</td>
<td>~220 sec</td>
<td>Requires recalculating date bounds</td>
</tr>
<tr class="even">
<td>upa_aggregation</td>
<td>~15 sec</td>
<td>Fast aggregation only</td>
</tr>
<tr class="odd">
<td>both</td>
<td>~235 sec</td>
<td>Sequential application</td>
</tr>
</tbody>
</table>
</div>
<div class="section level3">
<h3 id="determination-rates-by-year">Determination Rates by Year<a class="anchor" aria-label="anchor" href="#determination-rates-by-year"></a>
</h3>
<p>Based on real PNADC data (2012-2025, 55 quarters, 28.4M
observations):</p>
<table class="table">
<thead><tr class="header">
<th>Period</th>
<th>Rate</th>
<th>Notes</th>
</tr></thead>
<tbody>
<tr class="odd">
<td>2013-2019</td>
<td>97-99%</td>
<td>Best period (stable data collection)</td>
</tr>
<tr class="even">
<td>2020-2021</td>
<td>93-96%</td>
<td>COVID-19 degraded IBGE collection</td>
</tr>
<tr class="odd">
<td>2022-2024</td>
<td>95-97%</td>
<td>Post-pandemic normalization</td>
</tr>
<tr class="even">
<td>Boundary quarters</td>
<td>70-93%</td>
<td>First/last 4 quarters of any series</td>
</tr>
</tbody>
</table>
<p><strong>Why boundary quarters have lower rates</strong>: In PNADC’s
rotating panel (5 visits over 5 quarters), the boundary quarters of any
consecutive series include UPA-V1014 groups with fewer than 5 visits in
the data. For example, in a dataset of 9 consecutive quarters, only the
5th quarter has full panel utilization — households on their 1st through
5th visit all have complete histories.</p>
<hr>
</div>
</div>
<div class="section level2">
<h2 id="tips-and-best-practices">Tips and Best Practices<a class="anchor" aria-label="anchor" href="#tips-and-best-practices"></a>
</h2>
<ol style="list-style-type: decimal">
<li><p><strong>Stack data first</strong>: Load 2+ years before calling
<code><a href="../reference/pnadc_identify_periods.html">pnadc_identify_periods()</a></code> to maximize determination
rate.</p></li>
<li><p><strong>Validate inputs</strong>: Use
<code><a href="../reference/validate_pnadc.html">validate_pnadc()</a></code> to catch missing columns early.</p></li>
<li><p><strong>Check rates by year</strong>: Rates should be ~96-99% for
2013-2019. Lower rates suggest data issues or boundary effects.</p></li>
<li><p><strong>Handle indeterminate observations</strong>: Use
<code>keep_all = TRUE</code> (default) to preserve all observations;
indeterminate ones get <code>NA</code> weights.</p></li>
<li><p><strong>Verify population totals</strong>: Monthly weighted sums
should approximate Brazil’s population (~206 million in 2024).</p></li>
</ol>
<hr>
</div>
<div class="section level2">
<h2 id="further-reading">Further Reading<a class="anchor" aria-label="anchor" href="#further-reading"></a>
</h2>
<ul>
<li>
<a href="getting-started.html">Get Started</a> - Basic workflow for
using PNADCperiods</li>
<li>
<a href="applied-examples.html">Applied Examples</a> - COVID,
recession, and minimum wage validation</li>
<li>
<a href="annual-poverty-analysis.html">Annual Poverty Analysis</a> -
Monthly poverty with annual PNADC data</li>
<li>
<a href="complex-survey-design.html">Complex Survey Design</a> -
Standard errors and confidence intervals</li>
<li><a href="https://www.ibge.gov.br/estatisticas/sociais/trabalho/9171-pesquisa-nacional-por-amostra-de-domicilios-continua-mensal.html" class="external-link">IBGE
PNADC Documentation</a></li>
<li>Package function reference: <code><a href="../reference/pnadc_identify_periods.html">?pnadc_identify_periods</a></code>,
<code><a href="../reference/pnadc_apply_periods.html">?pnadc_apply_periods</a></code>
</li>
<li>Source code: <a href="https://github.com/antrologos/PNADCperiods" class="external-link">GitHub
repository</a>
</li>
</ul>
<hr>
</div>
<div class="section level2">
<h2 id="references">References<a class="anchor" aria-label="anchor" href="#references"></a>
</h2>
<ul>
<li>HECKSHER, Marcos. “Valor Impreciso por Mes Exato: Microdados e
Indicadores Mensais Baseados na Pnad Continua”. IPEA - Nota Tecnica
Disoc, n. 62. Brasilia, DF: IPEA, 2020. <a href="https://portalantigo.ipea.gov.br/portal/index.php?option=com_content&amp;view=article&amp;id=35453" class="external-link uri">https://portalantigo.ipea.gov.br/portal/index.php?option=com_content&amp;view=article&amp;id=35453</a>
</li>
<li>HECKSHER, M. “Cinco meses de perdas de empregos e simulacao de um
incentivo a contratacoes”. IPEA - Nota Tecnica Disoc, n. 87. Brasilia,
DF: IPEA, 2020.</li>
<li>HECKSHER, Marcos. “Mercado de trabalho: A queda da segunda quinzena
de marco, aprofundada em abril”. IPEA - Carta de Conjuntura, v. 47,
p. 1-6, 2020.</li>
<li>Barbosa, Rogerio J; Hecksher, Marcos. (2026). PNADCperiods: Identify
Reference Periods in Brazil’s PNADC Survey Data. R package version
v0.1.0. <a href="https://github.com/antrologos/PNADCperiods" class="external-link uri">https://github.com/antrologos/PNADCperiods</a>
</li>
</ul>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by <a href="https://orcid.org/0000-0002-6796-4547" class="external-link">Rogerio Barbosa</a>, <a href="https://orcid.org/0000-0003-2992-1252" class="external-link">Marcos Hecksher</a>.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.3.</p>
</div>

    </footer>
</div>





  </body>
</html>
