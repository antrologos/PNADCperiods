% Generated by roxygen2: do not edit by hand
% Please edit documentation in R/mensalizePNADC.R
\name{mensalizePNADC}
\alias{mensalizePNADC}
\title{Mensalize PNADC Quarterly Survey Data}
\usage{
mensalizePNADC(
  data,
  compute_weights = FALSE,
  monthly_totals = NULL,
  output = c("crosswalk", "microdata", "aggregates"),
  verbose = TRUE
)
}
\arguments{
\item{data}{A data.frame or data.table with stacked quarterly PNADC microdata.

For reference month identification only (\code{compute_weights = FALSE}),
minimum required columns are:
\itemize{
\item \code{Ano}, \code{Trimestre}: Year and quarter
\item \code{UPA}, \code{V1014}: Primary sampling unit and panel
\item \code{V2008}, \code{V20081}, \code{V20082}: Birth day, month, year
\item \code{V2009}: Age
}

For monthly weight computation (\code{compute_weights = TRUE}), additional
columns are required. See Details.}

\item{compute_weights}{Logical. If TRUE, compute monthly survey weights in
addition to identifying reference months. Default is FALSE.}

\item{monthly_totals}{A data.frame with monthly population totals for calibration.
Required if \code{compute_weights = TRUE}. Must contain:
\itemize{
\item \code{ref_month_yyyymm} or \code{anomesexato}: Month in YYYYMM format
\item \code{m_populacao}: Monthly population in thousands
}}

\item{output}{Character. What to return:
\itemize{
\item \code{"crosswalk"} (default): Minimal crosswalk for joining
\item \code{"microdata"}: Full microdata with all computed columns
\item \code{"aggregates"}: Monthly aggregated indicators
}}

\item{verbose}{Logical. Print progress messages? Default TRUE.}
}
\value{
Depends on \code{output} parameter:

If \code{output = "crosswalk"} (default):
A data.table with join keys and new time variables:
\itemize{
\item Join keys: \code{Ano}, \code{Trimestre}, \code{UPA}, \code{V1008}, \code{V1014}, \code{V2003}
\item \code{ref_month}: Reference month as Date
\item \code{ref_month_in_quarter}: Position in quarter (1, 2, 3) or NA
\item \code{ref_month_yyyymm}: Integer YYYYMM format
\item \code{weight_monthly}: Monthly weight (if \code{compute_weights = TRUE})
}

If \code{output = "microdata"}:
Full input data with all computed columns added.

If \code{output = "aggregates"}:
Monthly aggregated indicators.
}
\description{
This function processes stacked quarterly PNADC microdata to:
\enumerate{
\item Identify which month within each quarter each observation refers to
\item Optionally compute monthly survey weights (if \code{compute_weights = TRUE})
}

The output is a crosswalk table that can be joined with original (unstacked)
PNADC data files to add monthly time information.
}
\details{
Main function to convert quarterly PNADC survey data to monthly time series.
Returns a crosswalk data.frame for joining with original data, adding
reference month information and optionally monthly survey weights.
\subsection{Reference Month Identification}{

The algorithm determines which month each survey response refers to based on:
\itemize{
\item IBGE's "Parada Tecnica" rules for reference week timing
\item Respondent birthdates (constrains possible interview dates)
\item UPA-panel grouping (everyone interviewed together)
}

Typically 85-90\% of observations can be assigned a definite reference month.
}

\subsection{Monthly Weight Computation}{

When \code{compute_weights = TRUE}, the function:
\enumerate{
\item Redistributes quarterly weights to months using hierarchical rake weighting
\item Smooths monthly aggregates to remove quarterly artifacts
}

The resulting \code{weight_monthly} is the \strong{final} weight for general-purpose
monthly analysis. No Bayesian adjustment is applied.

For theme-specific calibration to match IBGE SIDRA series (e.g., unemployment
rate, employment levels), use \code{\link{calibrate_to_sidra}} separately.

Additional required columns for weight computation:
\itemize{
\item Survey design: \code{V1028}, \code{V1008}, \code{V2003}, \code{UF}, \code{posest}, \code{posest_sxi}
}
}
}
\examples{
\dontrun{
# Basic usage: identify reference months only
library(mensalizePNADC)

# Load stacked quarterly data (minimum columns)
pnadc <- data.table::fread("pnadc_stacked.csv",
  select = c("Ano", "Trimestre", "UPA", "V1008", "V1014", "V2003",
             "V2008", "V20081", "V20082", "V2009"))

# Get crosswalk
crosswalk <- mensalizePNADC(pnadc)

# Join with original quarterly file
original <- haven::read_dta("PNADC_2023T1.dta")
monthly <- dplyr::left_join(original, crosswalk,
  by = c("Ano", "Trimestre", "UPA", "V1008", "V1014", "V2003"))


# With monthly weights for general analysis
pnadc_full <- haven::read_dta("PNADCtrimestralempilhada.dta")
monthly_pop <- haven::read_dta("monthly_population_totals.dta")

result <- mensalizePNADC(pnadc_full,
  compute_weights = TRUE,
  monthly_totals = monthly_pop)

# Use weight_monthly for any monthly aggregate
result[, .(pop = sum(weight_monthly)), by = ref_month_yyyymm]
}

}
\seealso{
\code{\link{identify_reference_month}} for just reference month identification
\code{\link{calibrate_monthly_weights}} for weight calibration details
\code{\link{calibrate_to_sidra}} for theme-specific Bayesian calibration
\code{\link{compute_labor_indicators}} for computing indicators from results
}
