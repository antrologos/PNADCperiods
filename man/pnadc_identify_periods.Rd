% Generated by roxygen2: do not edit by hand
% Please edit documentation in R/pnadc-identify-periods.R
\name{pnadc_identify_periods}
\alias{pnadc_identify_periods}
\title{Identify Reference Periods in PNADC Data}
\usage{
pnadc_identify_periods(data, verbose = TRUE)
}
\arguments{
\item{data}{A data.frame or data.table with PNADC microdata. Required columns:
\itemize{
\item \code{Ano}: Survey year
\item \code{Trimestre}: Quarter (1-4)
\item \code{UPA}: Primary Sampling Unit
\item \code{V1008}: Household sequence within UPA
\item \code{V1014}: Panel identifier
\item \code{V2008}: Birth day (1-31)
\item \code{V20081}: Birth month (1-12)
\item \code{V20082}: Birth year
\item \code{V2009}: Age
}
Optional but recommended:
\itemize{
\item \code{V2003}: Person sequence within household
}}

\item{verbose}{Logical. If TRUE (default), display progress information.}
}
\value{
A data.table crosswalk with columns:
\describe{
\item{Ano, Trimestre, UPA, V1008, V1014}{Join keys (year, quarter, UPA, household, panel)}
\item{ref_month}{Reference month as Date (1st of month)}
\item{ref_month_in_quarter}{Position in quarter (1, 2, 3) or NA}
\item{ref_month_yyyymm}{Integer YYYYMM format (e.g., 202301)}
\item{determined_month}{Logical: TRUE if month was determined}
\item{ref_fortnight}{Reference fortnight as Date (1st or 16th)}
\item{ref_fortnight_in_quarter}{Position in quarter (1-6) or NA}
\item{ref_fortnight_yyyyff}{Integer YYYYFF format (1-24 per year)}
\item{determined_fortnight}{Logical: TRUE if fortnight was determined}
\item{ref_week}{Reference week as Date (Monday of week)}
\item{ref_week_in_quarter}{Position in quarter (1-14) or NA}
\item{ref_week_yyyyww}{Integer ISO YYYYWW format}
\item{determined_week}{Logical: TRUE if week was determined}
}
}
\description{
PNADC is a quarterly survey, but each interview actually refers to a specific
temporal period within the quarter. This function identifies which month,
fortnight (quinzena), and week each observation belongs to, enabling
sub-quarterly time series analysis.

The algorithm uses:
\itemize{
\item IBGE's reference week timing rules (first Saturday with sufficient days in month)
\item Respondent birthdates to constrain possible interview dates
\item UPA-panel level aggregation for months (across quarters - panel design)
\item Household-level aggregation for fortnights and weeks (within each quarter only)
\item Dynamic exception detection (identifies quarters needing relaxed rules)
}
}
\details{
Builds a universal crosswalk containing reference periods (month, fortnight,
and week) for PNADC survey data based on IBGE's interview timing rules.
\subsection{Temporal Granularity}{

The crosswalk contains three levels of temporal granularity:
\itemize{
\item \strong{Month}: 3 per quarter, ~97\% determination rate (aggregates across quarters)
\item \strong{Fortnight (quinzena)}: 6 per quarter, ~2-5\% determination rate (within-quarter only)
\item \strong{Week}: 13-14 per quarter, ~1-2\% determination rate (within-quarter only)
}

\strong{Why are fortnight/week rates so low?} Only months can aggregate at
UPA-V1014 level across ALL quarters (leveraging the panel design where the
same units are interviewed in consistent relative positions). Fortnights
and weeks are determined only from birthday constraints within a single
quarter, which rarely narrows the interview window to a single 15-day or
7-day period.
}

\subsection{Cross-Quarter Aggregation (Important!)}{

\strong{For optimal month determination rates, input data should be stacked across
multiple quarters} (ideally 4+ years). The algorithm leverages PNADC's
rotating panel design where the same UPA-V1014 is interviewed in the same
relative position across quarterly visits. This cross-quarter aggregation
only applies to months - fortnight and week determination is based on
within-quarter constraints only.
}

\subsection{Fortnight Definition}{

Fortnights are numbered 1-24 per year (2 per month):
\itemize{
\item Fortnight 01: Jan 1-15
\item Fortnight 02: Jan 16-31
\item Fortnight 03: Feb 1-15
\item ... and so on
}
}

\subsection{Important Note}{

This function returns only the crosswalk (identification keys + reference
periods). To apply the crosswalk to a dataset and optionally calibrate
weights, use \code{\link{pnadc_apply_periods}}.
}
}
\note{
\subsection{Aggregation Levels}{

The crosswalk aggregates at different levels:
\itemize{
\item \strong{Months}: Can aggregate across quarters at UPA-V1014 level
(PNADC panel design ensures same month position)
\item \strong{Fortnights}: Household level within quarter only
(no consistent position across quarterly visits)
\item \strong{Weeks}: Household level within quarter only
(no consistent position across quarterly visits)
}
}
}
\examples{
\dontrun{
# Build crosswalk from stacked quarterly data
crosswalk <- pnadc_identify_periods(pnadc_stacked)

# Check determination rates
crosswalk[, .(
  month_rate = mean(determined_month),
  fortnight_rate = mean(determined_fortnight),
  week_rate = mean(determined_week)
)]

# Apply to a specific dataset
result <- pnadc_apply_periods(pnadc_2023, crosswalk,
                              weight_var = "V1028",
                              anchor = "quarter")
}

}
\seealso{
\code{\link{pnadc_apply_periods}} to apply the crosswalk and
calibrate weights
}
