% Generated by roxygen2: do not edit by hand
% Please edit documentation in R/calibrate-ipf-weights.R
\name{pnadc_ipf_calibrate}
\alias{pnadc_ipf_calibrate}
\title{IPF Weight Calibration for PNADC Data}
\usage{
pnadc_ipf_calibrate(
  data,
  weight_var = "V1028",
  calibration_unit = "month",
  margins = c("age_group", "gender", "hh_group", "posest"),
  target_totals = NULL,
  bounds = c(0.1, 10),
  max_iter = 300L,
  tol = 1e-06,
  bias_correction = c("none", "propensity"),
  method = c("margin", "cell"),
  min_cell_size = 30L,
  verbose = TRUE
)
}
\arguments{
\item{data}{A data.table with period assignments from \code{pnadc_apply_periods()}
or \code{pnadc_identify_periods()}. Must contain the reference period columns
(e.g., \code{ref_month_yyyymm}) and demographic variables.}

\item{weight_var}{Character. Name of the original weight column, either
\code{"V1028"} (quarterly) or \code{"V1032"} (annual). Default: \code{"V1028"}.}

\item{calibration_unit}{Character. Time unit for calibration: \code{"month"},
\code{"fortnight"}, or \code{"week"}. Default: \code{"month"}.}

\item{margins}{Character vector of margin names to use. Available margins:
\code{"age_group"} (9 age categories), \code{"gender"} (male/female),
\code{"hh_group"} (household size: 1, 2, 3-4, 5+), \code{"posest"}
(IBGE post-stratum), \code{"rural_urban"} (requires V1022).
Default: \code{c("age_group", "gender", "hh_group", "posest")}.
Use fewer/simpler margins for sparse data (fortnight, week).}

\item{target_totals}{Optional data.table with external population totals from
\code{fetch_monthly_population()}. If provided, final weights are scaled to
match these totals. If NULL, weights preserve the sample's weighted totals.}

\item{bounds}{Numeric vector of length 2. Weight adjustment bounds as ratios
of the original weight, e.g., \code{c(0.1, 10)} allows weights to be reduced
to 10\\% or increased to 1000\\% of the original. Default: \code{c(0.1, 10)}.}

\item{max_iter}{Integer. Maximum number of IPF iterations. Default: 300.}

\item{tol}{Numeric. Convergence tolerance - iteration stops when the maximum
relative change in weights is below this value. Default: 1e-6.}

\item{bias_correction}{Character. Method for correcting selection bias in the
determined sample. Options: \code{"none"} (default, use standard weights),
\code{"propensity"} (use inverse probability weighting based on propensity
scores for being in the determined sample).}

\item{method}{Character. IPF method to use. Options: \code{"margin"} (default,
iterate over independent margins), \code{"cell"} (iterate over hierarchical
cells like nested raking, preserving anchor-period structure).}

\item{min_cell_size}{Integer. Minimum cell size threshold for adaptive margin
collapsing. If any margin has cells smaller than this, the margin categories
will be collapsed (e.g., 9 age groups -> 4). Default: 30. Set to 0 to disable.}

\item{verbose}{Logical. Print progress messages. Default: TRUE.}
}
\value{
The input data.table with a new weight column added:
\code{weight_ipf_monthly}, \code{weight_ipf_fortnightly}, or
\code{weight_ipf_weekly}, depending on \code{calibration_unit}.
}
\description{
Alternative weight calibration using Iterative Proportional Fitting (IPF).
Unlike the nested-cells raking in \code{pnadc_apply_periods()}, this function
adjusts weights to simultaneously match multiple independent margins:
age groups, gender, household size, posest, and optionally rural/urban.
}
\details{
The IPF algorithm iteratively adjusts weights to match target proportions for
each margin. \strong{Critically, target proportions are derived from the FULL
quarterly sample} (all observations, not just those with determined reference
periods). This corrects for selection bias in the month/fortnight/week
determined sample.

The algorithm flow:
\enumerate{
\item Create margin variables on ALL observations
\item (Optional) Compute propensity scores and IPW for bias correction
\item Calculate target proportions from FULL quarterly sample (unbiased)
\item (Optional) Adaptively collapse sparse margins
\item Filter to determined observations only
\item Run IPF iterations (margin-based or cell-based)
\item Apply weight bounds
\item Scale to SIDRA population totals (each period to its containing month)
}

Available margins: age_group (9 categories from V2009), gender (V2007),
hh_group (household size: 1, 2, 3-4, 5+), posest (IBGE post-stratum),
rural_urban (V1022, if available).

For sparse data (fortnight/week), use fewer margins to ensure convergence.
}
\section{Bias Correction}{

The \code{bias_correction = "propensity"} option models the probability of an
observation being in the determined sample using logistic regression with
age group, gender, posest (post-stratum), household size group, and rural/urban
as predictors. Inverse probability weights (IPW) are then used as initial
weights for IPF, directly addressing selection bias.
}

\section{Cell-Based IPF}{

The \code{method = "cell"} option runs IPF within hierarchical cells (similar
to nested raking) rather than matching independent margins. This preserves
anchor-period totals within cells and often produces better temporal consistency.
}

\section{Adaptive Margins}{

When \code{min_cell_size > 0}, margins with sparse cells are automatically
collapsed to prevent extreme weight adjustments. For example, 9 age groups
may be collapsed to 4 broader categories for fortnight/week calibration.
}

\examples{
\dontrun{
library(PNADCperiods)

# Standard workflow
crosswalk <- pnadc_identify_periods(pnadc_stacked)
result <- pnadc_apply_periods(pnadc_2020, crosswalk,
                               weight_var = "V1028",
                               calibrate = FALSE)

# Apply IPF calibration
sidra_pop <- fetch_monthly_population(2020, 2020)
result_ipf <- pnadc_ipf_calibrate(result,
                                   weight_var = "V1028",
                                   calibration_unit = "fortnight",
                                   target_totals = sidra_pop)

# Compare with standard calibration
result_std <- pnadc_apply_periods(pnadc_2020, crosswalk,
                                   calibrate = TRUE,
                                   calibration_unit = "fortnight")
}

}
