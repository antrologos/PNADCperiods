---
title: "Applied Examples: Quarterly vs Monthly Labor Market Series"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Applied Examples: Quarterly vs Monthly Labor Market Series}

  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.width = 8,
  fig.height = 5,
  eval = FALSE
)
```

## Introduction

This vignette demonstrates how to use `mensalizePNADC` to convert quarterly PNADC
data into monthly time series and compare labor market indicators at both frequencies.

Monthly data reveals dynamics that quarterly aggregates obscure:

- **Turning points** in economic cycles become visible earlier
- **Seasonal patterns** within quarters can be identified
- **Short-term shocks** (like COVID-19) show their true timing and magnitude
- **Policy evaluation** benefits from more precise timing

We'll compute four key labor market indicators:

1. **Unemployment rate** - National total
2. **Labor force participation** - By gender
3. **Formalization rate** - National total
4. **Employment level** - By race

## Setup

```{r packages, message=FALSE, warning=FALSE}
# Required packages
library(mensalizePNADC)
library(data.table)
library(ggplot2)
library(scales)

# Optional for data loading
library(fst)        # Fast data reading
library(lubridate)  # Date handling

# Set data.table threads
data.table::setDTthreads(4)

# Paths
pnadc_dir     <- "D:/Dropbox/Bancos_Dados/PNADC/Trimestral/Dados/"
processed_dir <- "D:/Dropbox/Artigos/mensalizacao_pnad/data/processed/"
```

## Step 1: Load and Prepare PNADC Data

First, we load stacked quarterly PNADC microdata. The data must include:

- **Mensalization columns**: `Ano`, `Trimestre`, `UPA`, `V1008`, `V1014`, `V2003`,
  `V2008`, `V20081`, `V20082`, `V2009`
- **Weight columns**: `V1028`, `UF`, `posest`, `posest_sxi`
- **Analysis columns**: `VD4001` (PEA), `VD4002` (employment status), `VD4009` (position),
  `VD4012` (contribution), `V2007` (sex), `V2010` (race)

```{r load-data}
# List all quarterly data files
files <- list.files(pnadc_dir, pattern = "\\.fst$", full.names = TRUE)
files <- files[!grepl("input", files)]

cat("Found", length(files), "quarterly files\n")

# Load and stack all quarters
# Select only necessary columns for efficiency
cols_needed <- c(

  # Identifiers and time
  "Ano", "Trimestre", "UF",
  # Mensalization columns
  "UPA", "Estrato", "V1008", "V1014", "V2003",
  "V2008", "V20081", "V20082", "V2009",
  # Weight columns
  "V1028", "posest", "posest_sxi",
  # Labor market variables
  "VD4001",  # PEA (economically active)
  "VD4002",  # Employment condition
  "VD4009",  # Position in occupation
  "VD4012",  # Social security contribution
  # Demographics
  "V2007",   # Sex
  "V2010"    # Race
)

# Load all files
pnadc_list <- lapply(files, function(f) {
  cat("Loading:", basename(f), "\n")
  dt <- read_fst(f, as.data.table = TRUE)
  setnames(dt, tolower(names(dt)))

  # Select available columns (handle case differences)
  available <- intersect(tolower(cols_needed), names(dt))
  dt <- dt[, ..available]

  # Standardize column names to expected case
  setnames(dt, names(dt),
           c("Ano", "Trimestre", "UF", "UPA", "Estrato", "V1008", "V1014",
             "V2003", "V2008", "V20081", "V20082", "V2009", "V1028",
             "posest", "posest_sxi", "VD4001", "VD4002", "VD4009",
             "VD4012", "V2007", "V2010")[seq_along(available)])

  dt
})

pnadc <- rbindlist(pnadc_list, fill = TRUE)
rm(pnadc_list); gc()

cat("\nTotal observations:", format(nrow(pnadc), big.mark = ","), "\n")
cat("Period:", min(pnadc$Ano), "Q", min(pnadc[Ano == min(Ano), Trimestre]),
    "to", max(pnadc$Ano), "Q", max(pnadc[Ano == max(Ano), Trimestre]), "\n")
```

## Step 2: Create Labor Market Variables

Before mensalization, we create the indicator variables we'll analyze.

```{r create-variables}
# Ensure numeric types
numeric_cols <- c("V2009", "V1028", "VD4001", "VD4002", "VD4009", "VD4012", "V2007", "V2010")
for (col in numeric_cols) {
  if (col %in% names(pnadc) && !is.numeric(pnadc[[col]])) {
    pnadc[, (col) := as.numeric(get(col))]
  }
}

# Filter to working-age population (14+)
pnadc <- pnadc[V2009 >= 14]

# Create labor market indicators
pnadc[, `:=`(
  # PEA: Economically Active Population (1 = yes)
  pea = fifelse(VD4001 == 1, 1L, 0L),

  # Employment condition (1 = employed, 0 = unemployed among PEA)
  employed = fifelse(VD4002 == 1, 1L, 0L),

  # Unemployed (among PEA)
  unemployed = fifelse(VD4001 == 1 & VD4002 == 2, 1L, 0L)
)]

# Formality indicator (among employed)
# Formal: positions 1,3,5,7 (formal employees) OR
#         positions 8,9 (employers/self-employed) with contribution
pnadc[, formal := fifelse(
  VD4009 %in% c(1L, 3L, 5L, 7L), 1L,
  fifelse(VD4009 %in% c(8L, 9L) & VD4012 == 1L, 1L, 0L)
)]
pnadc[VD4002 != 1, formal := NA_integer_]  # Only for employed

# Sex categories
pnadc[, sexo := fifelse(V2007 == 1, "Men", "Women")]

# Race categories
pnadc[, raca := fcase(
  V2010 == 1, "White",
  V2010 == 2, "Black",
  V2010 == 4, "Brown",
  V2010 %in% c(3, 5), "Other",
  default = NA_character_
)]

cat("Variables created\n")
cat("Working-age population (14+):", format(nrow(pnadc), big.mark = ","), "\n")
```

## Step 3: Apply Mensalization

Now we use `mensalizePNADC` to identify reference months and compute monthly weights.

```{r mensalize}
# Apply mensalization with weight computation
result <- mensalizePNADC(
  pnadc,
  compute_weights = TRUE,
  keep_all = TRUE,  # Keep indeterminate obs with NA weights

  verbose = TRUE
)

# Check determination rate
det_rate <- attr(result, "determination_rate")
cat("\nDetermination rate:", sprintf("%.1f%%", det_rate * 100), "\n")

# Merge mensalization results back to main data
pnadc <- merge(

  pnadc,
  result[, .(Ano, Trimestre, UPA, V1008, V1014, V2003,
             ref_month, ref_month_in_quarter, ref_month_yyyymm, weight_monthly)],
  by = c("Ano", "Trimestre", "UPA", "V1008", "V1014", "V2003"),
  all.x = TRUE
)

# Create date variables for plotting
pnadc[, `:=`(
  quarter_date = as.Date(paste0(Ano, "-", (Trimestre - 1) * 3 + 2, "-15")),
  month_date = ref_month
)]

cat("Mensalization complete\n")
cat("Observations with determined month:",
    format(sum(!is.na(pnadc$ref_month_in_quarter)), big.mark = ","),
    sprintf("(%.1f%%)", mean(!is.na(pnadc$ref_month_in_quarter)) * 100), "\n")
```

## Step 4: Compute Quarterly and Monthly Series

We now compute labor market indicators at both frequencies.

```{r compute-series}
# =============================================================================
# QUARTERLY SERIES (using original V1028 weights)
# =============================================================================

quarterly_total <- pnadc[, .(
  # Population counts
  pia = sum(V1028, na.rm = TRUE),
  pea = sum(pea * V1028, na.rm = TRUE),
  employed = sum(employed * V1028, na.rm = TRUE),
  unemployed = sum(unemployed * V1028, na.rm = TRUE),
  formal = sum(formal * V1028, na.rm = TRUE),

  # Rates
  unemployment_rate = sum(unemployed * V1028, na.rm = TRUE) /
                      sum(pea * V1028, na.rm = TRUE),
  participation_rate = sum(pea * V1028, na.rm = TRUE) /
                       sum(V1028, na.rm = TRUE),
  formalization_rate = sum(formal * V1028, na.rm = TRUE) /
                       sum(employed * V1028, na.rm = TRUE),
  employment_level = sum(employed * V1028, na.rm = TRUE) /
                     sum(V1028, na.rm = TRUE)
), by = .(Ano, Trimestre)]

quarterly_total[, `:=`(
  period = as.Date(paste0(Ano, "-", (Trimestre - 1) * 3 + 2, "-15")),
  frequency = "Quarterly"
)]

# By gender
quarterly_gender <- pnadc[!is.na(sexo), .(
  participation_rate = sum(pea * V1028, na.rm = TRUE) / sum(V1028, na.rm = TRUE),
  unemployment_rate = sum(unemployed * V1028, na.rm = TRUE) / sum(pea * V1028, na.rm = TRUE)
), by = .(Ano, Trimestre, sexo)]

quarterly_gender[, `:=`(
  period = as.Date(paste0(Ano, "-", (Trimestre - 1) * 3 + 2, "-15")),
  frequency = "Quarterly"
)]

# By race
quarterly_race <- pnadc[!is.na(raca) & raca %in% c("White", "Black", "Brown"), .(
  employment_level = sum(employed * V1028, na.rm = TRUE) / sum(V1028, na.rm = TRUE),
  unemployment_rate = sum(unemployed * V1028, na.rm = TRUE) / sum(pea * V1028, na.rm = TRUE)
), by = .(Ano, Trimestre, raca)]

quarterly_race[, `:=`(
  period = as.Date(paste0(Ano, "-", (Trimestre - 1) * 3 + 2, "-15")),
  frequency = "Quarterly"
)]

# =============================================================================
# MONTHLY SERIES (using weight_monthly)
# =============================================================================

# Filter to determined observations
pnadc_monthly <- pnadc[!is.na(weight_monthly)]

monthly_total <- pnadc_monthly[, .(
  # Population counts
  pia = sum(weight_monthly, na.rm = TRUE),
  pea = sum(pea * weight_monthly, na.rm = TRUE),
  employed = sum(employed * weight_monthly, na.rm = TRUE),
  unemployed = sum(unemployed * weight_monthly, na.rm = TRUE),
  formal = sum(formal * weight_monthly, na.rm = TRUE),

  # Rates
  unemployment_rate = sum(unemployed * weight_monthly, na.rm = TRUE) /
                      sum(pea * weight_monthly, na.rm = TRUE),
  participation_rate = sum(pea * weight_monthly, na.rm = TRUE) /
                       sum(weight_monthly, na.rm = TRUE),
  formalization_rate = sum(formal * weight_monthly, na.rm = TRUE) /
                       sum(employed * weight_monthly, na.rm = TRUE),
  employment_level = sum(employed * weight_monthly, na.rm = TRUE) /
                     sum(weight_monthly, na.rm = TRUE)
), by = ref_month_yyyymm]

monthly_total[, `:=`(
  period = as.Date(paste0(ref_month_yyyymm %/% 100, "-",
                          ref_month_yyyymm %% 100, "-15")),
  frequency = "Monthly"
)]

# By gender
monthly_gender <- pnadc_monthly[!is.na(sexo), .(
  participation_rate = sum(pea * weight_monthly, na.rm = TRUE) /
                       sum(weight_monthly, na.rm = TRUE),
  unemployment_rate = sum(unemployed * weight_monthly, na.rm = TRUE) /
                      sum(pea * weight_monthly, na.rm = TRUE)
), by = .(ref_month_yyyymm, sexo)]

monthly_gender[, `:=`(
  period = as.Date(paste0(ref_month_yyyymm %/% 100, "-",
                          ref_month_yyyymm %% 100, "-15")),
  frequency = "Monthly"
)]

# By race
monthly_race <- pnadc_monthly[!is.na(raca) & raca %in% c("White", "Black", "Brown"), .(
  employment_level = sum(employed * weight_monthly, na.rm = TRUE) /
                     sum(weight_monthly, na.rm = TRUE),
  unemployment_rate = sum(unemployed * weight_monthly, na.rm = TRUE) /
                      sum(pea * weight_monthly, na.rm = TRUE)
), by = .(ref_month_yyyymm, raca)]

monthly_race[, `:=`(
  period = as.Date(paste0(ref_month_yyyymm %/% 100, "-",
                          ref_month_yyyymm %% 100, "-15")),
  frequency = "Monthly"
)]

cat("Series computed\n")
cat("Quarterly observations:", nrow(quarterly_total), "\n
")
cat("Monthly observations:", nrow(monthly_total), "\n")
```

## Step 5: Save Processed Data

```{r save-data}
# Save series for future use
fst::write_fst(quarterly_total, paste0(processed_dir, "series_quarterly_total.fst"))
fst::write_fst(quarterly_gender, paste0(processed_dir, "series_quarterly_gender.fst"))
fst::write_fst(quarterly_race, paste0(processed_dir, "series_quarterly_race.fst"))

fst::write_fst(monthly_total, paste0(processed_dir, "series_monthly_total.fst"))
fst::write_fst(monthly_gender, paste0(processed_dir, "series_monthly_gender.fst"))
fst::write_fst(monthly_race, paste0(processed_dir, "series_monthly_race.fst"))

cat("Data saved to:", processed_dir, "\n")
```

---

## Comparison 1: Unemployment Rate (National)

The unemployment rate is the most watched labor market indicator. Monthly data
reveals the precise timing of turning points.

```{r plot-unemployment, fig.height=5}
# Combine quarterly and monthly data
unemployment_combined <- rbind(
  quarterly_total[, .(period, unemployment_rate, frequency)],
  monthly_total[, .(period, unemployment_rate, frequency)]
)

# Plot
ggplot(unemployment_combined, aes(x = period, y = unemployment_rate,
                                   color = frequency, linewidth = frequency)) +

  # Recession/crisis shading
geom_rect(data = data.frame(
    start = as.Date(c("2014-04-01", "2020-03-01")),
    end = as.Date(c("2017-01-01", "2021-06-01"))
  ), aes(xmin = start, xmax = end, ymin = -Inf, ymax = Inf),
  inherit.aes = FALSE, fill = "purple", alpha = 0.1) +

  geom_line() +

  scale_y_continuous(labels = percent_format(accuracy = 0.1),
                     breaks = seq(0, 0.20, 0.02)) +
  scale_x_date(date_breaks = "1 year", date_labels = "%Y") +
  scale_color_manual(values = c("Quarterly" = "steelblue", "Monthly" = "darkred")) +
  scale_linewidth_manual(values = c("Quarterly" = 1.5, "Monthly" = 0.8)) +

  labs(
    title = "Unemployment Rate: Quarterly vs Monthly",
    subtitle = "Brazil, 2012-2025. Shaded areas: 2014-17 recession and COVID-19 pandemic",
    x = NULL, y = "Unemployment Rate",
    color = "Frequency", linewidth = "Frequency",
    caption = "Source: PNADC/IBGE. Monthly series computed with mensalizePNADC."
  ) +

  theme_minimal(base_size = 12) +
  theme(
    legend.position = "bottom",
    plot.title = element_text(face = "bold"),
    axis.text.x = element_text(angle = 45, hjust = 1)
  )
```

**Key insights from monthly data:**

- The unemployment peak during COVID-19 can be precisely dated to a specific month
- Seasonal patterns within quarters become visible
- The recovery trajectory shows month-by-month progress

---

## Comparison 2: Labor Force Participation by Gender

Labor force participation shows strong gender differences. Monthly data reveals
how shocks affected men and women differently.

```{r plot-participation-gender, fig.height=6}
# Combine data
participation_gender <- rbind(
  quarterly_gender[, .(period, sexo, participation_rate, frequency)],
  monthly_gender[, .(period, sexo, participation_rate, frequency)]
)

ggplot(participation_gender, aes(x = period, y = participation_rate,
                                  color = sexo, linetype = frequency)) +

  # COVID shading
  geom_rect(data = data.frame(
    start = as.Date("2020-03-01"),
    end = as.Date("2021-06-01")
  ), aes(xmin = start, xmax = end, ymin = -Inf, ymax = Inf),
  inherit.aes = FALSE, fill = "purple", alpha = 0.1) +

  geom_line(linewidth = 0.8) +

  scale_y_continuous(labels = percent_format(accuracy = 1),
                     limits = c(0.45, 0.80)) +
  scale_x_date(date_breaks = "2 years", date_labels = "%Y") +
  scale_color_manual(values = c("Men" = "steelblue", "Women" = "coral")) +
  scale_linetype_manual(values = c("Quarterly" = "solid", "Monthly" = "dashed")) +

  labs(
    title = "Labor Force Participation Rate by Gender",
    subtitle = "Quarterly (solid) vs Monthly (dashed). Shaded: COVID-19 pandemic",
    x = NULL, y = "Participation Rate",
    color = "Gender", linetype = "Frequency",
    caption = "Source: PNADC/IBGE. Monthly series computed with mensalizePNADC."
  ) +

  theme_minimal(base_size = 12) +
  theme(
    legend.position = "bottom",
    plot.title = element_text(face = "bold"),
    axis.text.x = element_text(angle = 45, hjust = 1)
  )
```

**Key insights:**

- Women's participation dropped more sharply during COVID-19
- Monthly data shows the exact timing of the collapse and recovery
- The gender gap widened during the pandemic before narrowing again

---

## Comparison 3: Formalization Rate (National)

The formalization rate measures the share of formal employment. This indicator
is crucial for understanding labor market quality.

```{r plot-formalization, fig.height=5}
# Combine data
formalization_combined <- rbind(
  quarterly_total[, .(period, formalization_rate, frequency)],
  monthly_total[, .(period, formalization_rate, frequency)]
)

ggplot(formalization_combined, aes(x = period, y = formalization_rate,
                                    color = frequency, linewidth = frequency)) +

  # Crisis shading
  geom_rect(data = data.frame(
    start = as.Date(c("2014-04-01", "2020-03-01")),
    end = as.Date(c("2017-01-01", "2021-06-01"))
  ), aes(xmin = start, xmax = end, ymin = -Inf, ymax = Inf),
  inherit.aes = FALSE, fill = "purple", alpha = 0.1) +

  geom_line() +

  scale_y_continuous(labels = percent_format(accuracy = 1),
                     limits = c(0.55, 0.70)) +
  scale_x_date(date_breaks = "1 year", date_labels = "%Y") +
  scale_color_manual(values = c("Quarterly" = "steelblue", "Monthly" = "darkgreen")) +
  scale_linewidth_manual(values = c("Quarterly" = 1.5, "Monthly" = 0.8)) +

  labs(
    title = "Formalization Rate: Quarterly vs Monthly",
    subtitle = "Share of formal employment among all employed. Shaded: economic crises",
    x = NULL, y = "Formalization Rate",
    color = "Frequency", linewidth = "Frequency",
    caption = "Source: PNADC/IBGE. Formal = CLT + statutory + contributing self-employed/employers."
  ) +

  theme_minimal(base_size = 12) +
  theme(
    legend.position = "bottom",
    plot.title = element_text(face = "bold"),
    axis.text.x = element_text(angle = 45, hjust = 1)
  )
```

**Key insights:**

- Formalization declined during both the 2014-17 recession and COVID-19
- Monthly data reveals seasonal patterns (e.g., year-end temporary contracts)
- The 2017 labor reform effects can be tracked month-by-month

---

## Comparison 4: Employment Level by Race

Employment levels by race reveal structural inequalities in the labor market.

```{r plot-employment-race, fig.height=6}
# Combine data
employment_race <- rbind(
  quarterly_race[, .(period, raca, employment_level, frequency)],
  monthly_race[, .(period, raca, employment_level, frequency)]
)

ggplot(employment_race, aes(x = period, y = employment_level,
                             color = raca, linetype = frequency)) +

  # COVID shading
  geom_rect(data = data.frame(
    start = as.Date("2020-03-01"),
    end = as.Date("2021-06-01")
  ), aes(xmin = start, xmax = end, ymin = -Inf, ymax = Inf),
  inherit.aes = FALSE, fill = "purple", alpha = 0.1) +

  geom_line(linewidth = 0.8) +

  scale_y_continuous(labels = percent_format(accuracy = 1)) +
  scale_x_date(date_breaks = "2 years", date_labels = "%Y") +
  scale_color_brewer(palette = "Set1") +
  scale_linetype_manual(values = c("Quarterly" = "solid", "Monthly" = "dashed")) +

  labs(
    title = "Employment Level by Race",
    subtitle = "Quarterly (solid) vs Monthly (dashed). Shaded: COVID-19 pandemic",
    x = NULL, y = "Employment Level (Employed / Working-age Pop.)",
    color = "Race", linetype = "Frequency",
    caption = "Source: PNADC/IBGE. Monthly series computed with mensalizePNADC."
  ) +

  theme_minimal(base_size = 12) +
  theme(
    legend.position = "bottom",
    plot.title = element_text(face = "bold"),
    axis.text.x = element_text(angle = 45, hjust = 1)
  )
```

**Key insights:**

- Black and Brown workers faced larger employment drops during COVID-19
- Monthly data shows that recovery was also slower for these groups
- Racial gaps in employment are persistent across the entire period

---

## Summary: Why Monthly Data Matters

| Aspect | Quarterly Data | Monthly Data |
|--------|---------------|--------------|
| **Timing** | 3-month averages obscure turning points | Precise month of changes visible |
| **Seasonality** | Hidden within quarters | Clear seasonal patterns |
| **Shock analysis** | Delayed/smoothed response | Real-time impact visible |
| **Policy evaluation** | Imprecise timing | Can link to specific policy dates |
| **Short-term forecasting** | Limited lead time | More frequent updates |

The `mensalizePNADC` package achieves **97% determination rate**, meaning nearly
all observations can be assigned to specific months with properly calibrated weights.

---

## Technical Notes

### Weight Calibration

The `weight_monthly` variable is calibrated to match IBGE's monthly population
estimates from SIDRA table 6022. This ensures that:

- Monthly population totals match official estimates
- Weighted aggregates are representative at the monthly level
- Comparisons between months are valid

### Handling Indeterminate Observations

About 3% of observations cannot have their reference month determined. These
receive `weight_monthly = NA` and are excluded from monthly aggregates. For
most analyses, this has minimal impact on estimates.

### Reproducibility

All processed series are saved to `data/processed/` for reproducibility:

```{r list-saved-files}
list.files(processed_dir, pattern = "series_")
```

To reload the series without reprocessing:

```{r reload-data, eval=FALSE}
monthly_total <- fst::read_fst(paste0(processed_dir, "series_monthly_total.fst"),
                                as.data.table = TRUE)
quarterly_total <- fst::read_fst(paste0(processed_dir, "series_quarterly_total.fst"),
                                  as.data.table = TRUE)
```

## References

- IBGE. Pesquisa Nacional por Amostra de Domicilios Continua (PNADC).
  https://www.ibge.gov.br/estatisticas/sociais/trabalho/
- Hecksher, M. (2024). Mensalizacao da PNADC. Working paper.
