---
title: "Determination Rates Benchmark Report"
subtitle: "PNADCperiods Package Performance Analysis"
author: "Generated from complete PNADC data (2012-2025)"
date: "`r Sys.Date()`"
output:
  html_document:
    toc: true
    toc_depth: 3
    toc_float: true
    number_sections: true
    theme: flatly
    highlight: tango
    code_folding: show
vignette: >
  %\VignetteIndexEntry{Determination Rates Benchmark Report}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(

  echo = TRUE,
  eval = FALSE,
  message = FALSE,
  warning = FALSE,
  comment = "#>"
)
```

# Executive Summary

This document presents comprehensive benchmark results for the PNADCperiods package,
tested on complete PNADC quarterly data from 2012 to 2025 (55 quarters, 28.4 million
individual observations, 9.6 million unique household-quarter combinations).

## Key Results

| Metric | Value |
|--------|-------|
| **Total rows processed** | 28,395,273 |
| **Unique household-quarters** | 9,598,723 |
| **Month determination rate** | 96.69% |
| **Fortnight determination rate** | 7.64% |
| **Week determination rate** | 1.54% |
| **Processing time** | 160.2 seconds |
| **Throughput** | 177,303 rows/sec |

## Experimental Strategies Summary

| Strategy | Fortnight % | Week % | Execution Time |
|----------|-------------|--------|----------------|
| Strict (baseline) | 7.64% | 1.54% | — |
| + Probabilistic | 13.61% | 1.82% | ~220s |
| + UPA Aggregation | 57.69% | 14.36% | ~15s |
| + Both | **60.33%** | **14.60%** | ~235s |

**Key finding:** UPA homogeneity rate = **100%** for both fortnights and weeks.

---

# Data Description

## Source

- **Dataset**: PNADC (Pesquisa Nacional por Amostra de Domicílios Contínua)
- **Source**: IBGE (Brazilian Institute of Geography and Statistics)
- **Type**: Quarterly household survey microdata
- **Format**: FST files (fast serialization)

## Coverage

| Dimension | Value |
|-----------|-------|
| Years | 2012-2025 |
| Quarters | 55 |
| Total observations | 28,395,273 |
| Unique households per quarter | ~175,000 |
| Unique UPAs (Primary Sampling Units) | ~3,500 per quarter |

## Variables Used

The following variables are required for period identification:

| Variable | Description | Used For |
|----------|-------------|----------|
| `Ano` | Survey year | Period calculation |
| `Trimestre` | Quarter (1-4) | Period calculation |
| `UPA` | Primary Sampling Unit | Cross-quarter aggregation |
| `V1008` | Household sequence within UPA | Household identification |
| `V1014` | Panel identifier | Cross-quarter aggregation |
| `V2008` | Birth day (1-31) | Birthday constraint |
| `V20081` | Birth month (1-12) | Birthday constraint |
| `V20082` | Birth year | Birthday constraint |
| `V2009` | Age | Birthday constraint validation |

---

# Functions Tested

## `pnadc_identify_periods()`

The main function for building the reference period crosswalk.

### Function Signature

```{r}
pnadc_identify_periods(
  data,
  verbose = TRUE
)
```
### Arguments

| Argument | Type | Default | Description |
|----------|------|---------|-------------|
| `data` | data.frame/data.table | (required) | PNADC microdata with required columns |
| `verbose` | logical | TRUE | Display progress information |

### Return Value

A `data.table` crosswalk with the following columns:

| Column | Type | Description |
|--------|------|-------------|
| `Ano` | integer | Survey year |
| `Trimestre` | integer | Quarter (1-4) |
| `UPA` | character | Primary Sampling Unit |
| `V1008` | integer | Household sequence |
| `V1014` | integer | Panel identifier |
| `ref_month` | Date | Reference month (1st of month) |
| `ref_month_in_quarter` | integer | Month position in quarter (1-3) |
| `ref_month_yyyymm` | integer | Month in YYYYMM format |
| `determined_month` | logical | TRUE if month was determined |
| `ref_fortnight` | Date | Reference fortnight (1st or 16th) |
| `ref_fortnight_in_quarter` | integer | Fortnight position (1-6) |
| `ref_fortnight_yyyyff` | integer | Fortnight in YYYYFF format |
| `determined_fortnight` | logical | TRUE if fortnight was determined |
| `ref_week` | Date | Reference week start (Monday) |
| `ref_week_in_quarter` | integer | Week position (1-13/14) |
| `ref_week_yyyyww` | integer | ISO week in YYYYWW format |
| `determined_week` | logical | TRUE if week was determined |

### Algorithm Overview

1. **Preprocessing**: Convert input to data.table, handle special codes (99, 9999)
2. **Saturday calculation**: Compute first valid interview Saturday for each month using IBGE's "Parada Técnica" rules (min 4 days in month, or 3 for exceptions)
3. **Birthday constraints**: Narrow interview date range based on respondent birthdates
4. **Period position conversion**: Convert date bounds to month/fortnight/week positions
5. **Cross-quarter aggregation** (months only): Aggregate constraints at UPA-V1014 level across ALL quarters
6. **Within-quarter aggregation** (fortnight/week): Aggregate at household level within each quarter
7. **Exception detection**: Identify quarters requiring relaxed rules
8. **Final determination**: If min position == max position, period is determined

---

## `pnadc_experimental_periods()`
Experimental function providing probabilistic period assignment for narrow ranges.

### Function Signature

```{r}
pnadc_experimental_periods(
crosswalk,
  data = NULL,
  strategy = c("none", "probabilistic", "upa_aggregation", "both"),
  upa_homogeneity_threshold = 0.80,
  verbose = TRUE
)
```

### Arguments

| Argument | Type | Default | Description |
|----------|------|---------|-------------|
| `crosswalk` | data.table | (required) | Crosswalk from `pnadc_identify_periods()` |
| `data` | data.table | NULL | Original PNADC data (required for probabilistic) |
| `strategy` | character | "none" | Strategy to apply |
| `upa_homogeneity_threshold` | numeric | 0.80 | Threshold for UPA aggregation |
| `verbose` | logical | TRUE | Display progress information |

### Strategies

1. **probabilistic**: For undetermined cases where the date range spans exactly 2 periods,
   calculates the probability-weighted best guess based on date midpoint position.

2. **upa_aggregation**: Aggregates constraints at UPA level. For each UPA where all
   strictly determined households have the same fortnight/week, propagates that
   assignment to undetermined households in the same UPA.

3. **both**: Applies both strategies sequentially (probabilistic first, then UPA aggregation).

### Additional Output Columns

| Column | Type | Description |
|--------|------|-------------|
| `ref_fortnight_likely` | integer | Probabilistic fortnight assignment (strategy: probabilistic/both) |
| `ref_fortnight_confidence` | numeric | Confidence score 0.5-1.0 (strategy: probabilistic/both) |
| `ref_week_likely` | integer | Probabilistic week assignment (strategy: probabilistic/both) |
| `ref_week_confidence` | numeric | Confidence score 0.5-1.0 (strategy: probabilistic/both) |
| `ref_fortnight_upa` | integer | UPA-aggregated fortnight (strategy: upa_aggregation/both) |
| `ref_week_upa` | integer | UPA-aggregated week (strategy: upa_aggregation/both) |

---

# Benchmark Results

## Test Environment

| Component | Specification |
|-----------|---------------|
| **R version** | 4.5.0 |
| **Platform** | Windows 11 x64 |
| **CPU** | (local machine) |
| **RAM** | Sufficient for 3GB dataset |
| **data.table version** | 1.16+ |
| **Test date** | 2026-01-18 |

## Data Loading Performance

```
Data loading: 310.8 seconds
Total rows: 28,395,273
Memory usage: 3 GB
Files loaded: 55 quarterly FST files
```

## Period Identification Performance

### `pnadc_identify_periods()`

| Metric | Value |
|--------|-------|
| **Execution time** | 160.2 seconds |
| **Input rows** | 28,395,273 |
| **Output rows** | 9,598,723 |
| **Throughput** | 177,303 rows/sec |
| **Memory (output)** | 918.1 MB |

### `pnadc_experimental_periods()`

| Metric | Value |
|--------|-------|
| **Execution time** | 681.4 seconds |
| **Input rows** | 9,598,723 (crosswalk) |
| **Throughput** | 14,088 rows/sec |
| **Memory (output)** | 1.1 GB |

---

# Determination Rate Analysis

## Overall Rates

| Period | Determined | Total | Rate |
|--------|------------|-------|------|
| **Month** | 9,281,135 | 9,598,723 | **96.69%** |
| **Fortnight** | 733,744 | 9,598,723 | **7.64%** |
| **Week** | 147,692 | 9,598,723 | **1.54%** |

## Rates by Year

| Year | N | Month % | Fortnight % | Week % |
|------|---|---------|-------------|--------|
| 2012 | 695,083 | 96.29 | 8.46 | 1.65 |
| 2013 | 719,697 | 98.72 | 8.52 | 1.39 |
| 2014 | 739,655 | 98.39 | 8.08 | 1.30 |
| 2015 | 745,247 | 98.24 | 8.12 | 1.62 |
| 2016 | 749,631 | 97.22 | 7.69 | 2.08 |
| 2017 | 752,066 | 96.88 | 7.49 | 1.78 |
| 2018 | 750,274 | 97.07 | 7.60 | 1.47 |
| 2019 | 746,873 | 97.63 | 7.79 | 1.26 |
| 2020 | 535,970 | 96.26 | 7.61 | 1.27 |
| 2021 | 544,817 | 93.29 | 6.86 | 1.94 |
| 2022 | 679,389 | 95.03 | 7.05 | 1.73 |
| 2023 | 690,749 | 96.18 | 7.09 | 1.66 |
| 2024 | 708,340 | 97.27 | 7.30 | 1.28 |
| 2025 | 540,932 | 93.07 | 6.91 | 0.99 |

**Notes:**
- 2020-2021 show lower rates due to COVID-19 pandemic disruptions
- 2025 has partial data (Q1 only at time of test)

## Rates by Quarter

| Quarter | N | Month % | Fortnight % | Week % |
|---------|---|---------|-------------|--------|
| Q1 | 2,439,072 | 96.58 | 7.46 | 1.49 |
| Q2 | 2,425,552 | 96.77 | 7.88 | 1.65 |
| Q3 | 2,468,025 | 96.38 | 7.78 | 1.56 |
| Q4 | 2,266,074 | 97.06 | 7.44 | 1.45 |

Rates are consistent across quarters, indicating the algorithm works uniformly.

---

# Distribution Analysis

## Month Distribution (Within Quarter)

| Position | N | Percentage |
|----------|---|------------|
| Month 1 | 3,144,100 | 33.88% |
| Month 2 | 3,046,495 | 32.82% |
| Month 3 | 3,090,540 | 33.30% |

**Interpretation**: Near-uniform distribution across the three months of each quarter,
indicating no systematic bias in the identification algorithm.

## Fortnight Distribution (Within Quarter)

| Position | N | Percentage |
|----------|---|------------|
| Fortnight 1 | 110,060 | 15.00% |
| Fortnight 2 | 135,157 | 18.42% |
| Fortnight 3 | 94,558 | 12.89% |
| Fortnight 4 | 146,057 | 19.91% |
| Fortnight 5 | 102,265 | 13.94% |
| Fortnight 6 | 145,647 | 19.85% |

**Interpretation**: Some imbalance, with second fortnights of each month (positions 2, 4, 6)
having higher determination rates. This is expected due to birthday constraint patterns.

## Week Distribution (Within Quarter)

| Position | N | Percentage |
|----------|---|------------|
| Week 1 | 30,895 | 20.92% |
| Week 2 | 2,212 | 1.50% |
| Week 3 | 2,082 | 1.41% |
| Week 4 | 9,047 | 6.13% |
| Week 5 | 19,615 | 13.28% |
| Week 6 | 2,331 | 1.58% |
| Week 7 | 2,157 | 1.46% |
| Week 8 | 12,781 | 8.65% |
| Week 9 | 21,841 | 14.79% |
| Week 10 | 2,271 | 1.54% |
| Week 11 | 2,172 | 1.47% |
| Week 12 | 25,301 | 17.13% |
| Week 13 | 14,987 | 10.15% |

**Interpretation**: Strong concentration in weeks 1, 5, 9, 12-13 (first weeks of each month
and last weeks of quarter). Middle weeks within months have very low determination rates.

---

# Experimental Results

## Strategy Comparison

All three experimental strategies were tested with threshold values of 0.8 and 0.9.
Since UPA homogeneity is 100%, threshold values have no effect on results.

| Strategy | Threshold | Fortnight % | Week % | Time (s) |
|----------|-----------|-------------|--------|----------|
| probabilistic | 0.8 | 13.61% | 1.82% | 221.0 |
| probabilistic | 0.9 | 13.61% | 1.82% | 223.8 |
| upa_aggregation | 0.8 | 57.69% | 14.36% | 15.2 |
| upa_aggregation | 0.9 | 57.69% | 14.36% | 14.8 |
| both | 0.8 | **60.33%** | **14.60%** | 235.1 |
| both | 0.9 | **60.33%** | **14.60%** | 234.6 |

## Probabilistic Strategy

### Fortnight

| Metric | Value |
|--------|-------|
| Strictly determined | 733,744 (7.64%) |
| Probabilistically assigned | 572,939 (5.97%) |
| **Total with estimate** | **1,306,683 (13.61%)** |
| Improvement | +5.97 percentage points |

### Week

| Metric | Value |
|--------|-------|
| Strictly determined | 147,692 (1.54%) |
| Probabilistically assigned | 26,878 (0.28%) |
| **Total with estimate** | **174,570 (1.82%)** |
| Improvement | +0.28 percentage points |

### Confidence Score Distribution

**Fortnight Confidence:**

| Range | N | Percentage |
|-------|---|------------|
| (0.5, 0.6] | 383,328 | 66.9% |
| (0.6, 0.7] | 165,280 | 28.8% |
| (0.7, 0.8] | 22,506 | 3.9% |
| (0.8, 0.9] | 481 | 0.1% |
| (0.9, 1.0] | 1,344 | 0.2% |

- Mean confidence: 0.576
- Median confidence: 0.548
- Range: [0.516, 0.950]

**Week Confidence:**

- Mean confidence: 0.571
- Median confidence: 0.571
- All assignments have confidence = 0.571 (fixed range of 2 weeks)

## UPA Aggregation Strategy

### UPA Homogeneity Analysis

| Period | Homogeneity Rate | Applied |
|--------|------------------|---------|
| Fortnight | **100.0%** | Yes |
| Week | **100.0%** | Yes |

**Key finding:** Whenever a fortnight or week IS strictly determined for any household
in a UPA, ALL strictly determined households in that UPA have the SAME fortnight/week.
This 100% homogeneity rate provides strong empirical support for using UPA-level aggregation.

### Fortnight

| Metric | Value |
|--------|-------|
| Strictly determined | 733,744 (7.64%) |
| UPA-aggregated (additional) | 4,803,577 (50.04%) |
| **Total** | **5,537,321 (57.69%)** |
| Improvement | +50.04 percentage points |

### Week

| Metric | Value |
|--------|-------|
| Strictly determined | 147,692 (1.54%) |
| UPA-aggregated (additional) | 1,230,647 (12.82%) |
| **Total** | **1,378,339 (14.36%)** |
| Improvement | +12.82 percentage points |

## Combined Strategy ("both")

When combining both strategies:

### Fortnight

| Metric | Value |
|--------|-------|
| Strictly determined | 733,744 (7.64%) |
| Probabilistically assigned | 572,939 (5.97%) |
| UPA-aggregated | 4,803,577 (50.04%) |
| **Total** | **5,790,860 (60.33%)** |

### Week

| Metric | Value |
|--------|-------|
| Strictly determined | 147,692 (1.54%) |
| Probabilistically assigned | 26,878 (0.28%) |
| UPA-aggregated | 1,230,647 (12.82%) |
| **Total** | **1,401,147 (14.60%)**

---

# Recommendations

## When to Use Each Strategy

| Scenario | Recommended Strategy | Notes |
|----------|---------------------|-------|
| **Conservative analysis** | `pnadc_identify_periods()` | Use strict determination only (7.64% fortnight, 1.54% week) |
| **Moderate coverage** | `strategy = "probabilistic"` | Adds assignments with confidence scores (13.61% fortnight, 1.82% week) |
| **Maximum coverage** | `strategy = "upa_aggregation"` | Best coverage, fastest execution (57.69% fortnight, 14.36% week) |
| **Comprehensive** | `strategy = "both"` | Combines all experimental strategies (60.33% fortnight, 14.60% week) |

## UPA Aggregation Considerations

The 100% UPA homogeneity rate suggests that IBGE's interview scheduling creates
natural clustering at the UPA level. This means:

1. **Strong empirical basis**: When any household in a UPA has a determined period,
   ALL households with determined periods in that UPA have the SAME period.

2. **Threshold is irrelevant**: Since homogeneity is 100%, any threshold ≤ 100%
   will activate UPA aggregation.

3. **Potential for main algorithm**: These results suggest UPA aggregation could
   potentially be incorporated into the main algorithm, pending methodological review.

## Confidence Thresholds (Probabilistic Strategy)

For probabilistic assignments, consider these thresholds:

| Confidence | Use Case |
|------------|----------|
| ≥ 0.7 | Conservative analysis (24,331 additional fortnights) |
| ≥ 0.6 | Moderate analysis (189,611 additional fortnights) |
| ≥ 0.5 | Maximum coverage (572,939 additional fortnights) |

## Performance Optimization

1. **Use stacked multi-year data**: Month determination improves significantly with more quarters
2. **Subset columns first**: Only load required columns to reduce memory
3. **Use FST format**: Fastest loading for large datasets
4. **data.table threading**: Package automatically uses all available cores

---

# Reproducibility

## Code to Reproduce

```{r, eval=FALSE}
library(PNADCperiods)
library(data.table)
library(fst)

# Load data
data_path <- "path/to/pnadc/quarterly/data/"
files <- list.files(data_path, pattern = "\\.fst$", full.names = TRUE)

pnadc_list <- lapply(files, function(f) {
  dt <- read_fst(f, as.data.table = TRUE)
  cols <- c("Ano", "Trimestre", "UPA", "V1008", "V1014",
            "V2008", "V20081", "V20082", "V2009")
  dt[, ..cols]
})
pnadc_stacked <- rbindlist(pnadc_list, fill = TRUE)

# Run identification
system.time({
  crosswalk <- pnadc_identify_periods(pnadc_stacked)
})

# Check rates
crosswalk[, .(
  month_rate = mean(determined_month),
  fortnight_rate = mean(determined_fortnight),
  week_rate = mean(determined_week)
)]

# Run experimental with probabilistic strategy
crosswalk_prob <- pnadc_experimental_periods(
  crosswalk,
  pnadc_stacked,
  strategy = "probabilistic"
)

# Check probabilistic improvement
crosswalk_prob[, .(
  fortnight_total = mean(determined_fortnight | !is.na(ref_fortnight_likely)),
  week_total = mean(determined_week | !is.na(ref_week_likely))
)]

# Run experimental with UPA aggregation strategy
crosswalk_upa <- pnadc_experimental_periods(
  crosswalk,
  pnadc_stacked,
  strategy = "upa_aggregation",
  upa_homogeneity_threshold = 0.80
)

# Check UPA improvement
crosswalk_upa[, .(
  fortnight_total = mean(determined_fortnight | !is.na(ref_fortnight_upa)),
  week_total = mean(determined_week | !is.na(ref_week_upa))
)]

# Run experimental with both strategies
crosswalk_both <- pnadc_experimental_periods(
  crosswalk,
  pnadc_stacked,
  strategy = "both",
  upa_homogeneity_threshold = 0.80
)

# Check combined improvement
crosswalk_both[, .(
  fortnight_total = mean(determined_fortnight |
                         !is.na(ref_fortnight_likely) |
                         !is.na(ref_fortnight_upa)),
  week_total = mean(determined_week |
                    !is.na(ref_week_likely) |
                    !is.na(ref_week_upa))
)]
```

---
# Session Info

```{r, eval=TRUE, echo=FALSE}
sessionInfo()
```

---

*Report generated: `r Sys.time()`*

*Package version: PNADCperiods 2.0.0*
